<!DOCTYPE html>
<html><head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="alternate" type="application/rss+xml" href="https://frier17.github.io/hugo_tutorial/chapter5/index.xml" title="100 Pages to  FastAPI" />
    <link rel="canonical" href="https://frier17.github.io/hugo_tutorial/chapter5/">

    <title>
        
        The business domain entities and database layer | 100 Pages to  FastAPI
        
    </title>

    
    <link href="https://frier17.github.io/hugo_tutorial/css/fontawesome.min.css" rel="stylesheet">

    
    <link rel="stylesheet" href="https://frier17.github.io/hugo_tutorial/css/ace.min.css">

    

    
    
        
    

</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow sticky-top" id="navbarMain">
    <div class="container">
        <div>
            <a class="navbar-brand" href="/hugo_tutorial">
                
                100 Pages to  FastAPI
            </a>
        </div>
        
    </div>
    <div class="feed-icons">
            <a href="https://frier17.github.io/hugo_tutorial/chapter5/index.xml"><img src="/img/feed-icon.svg" alt="RSS feed" /></a>
        </div>
    </nav>
<div class="container-fluid">
            <div class="row">

                <div class="docs-sidenav order-0 col-12 col-md-3 col-lg-2 col-xl-2 position-sticky border-right"><nav class="navbar navbar-expand-md navbar-light pl-0">
    <button class="navbar-toggler navbar-toggler-right collapsed" type="button" data-toggle="collapse" data-target="#sidenav-left-collapse" aria-controls="sidenav-left-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

     <div class="collapse navbar-collapse align-items-start flex-column" id="sidenav-left-collapse">
            <form class="form-inline my-2 my-lg-0 searchbox">
                <input class="form-control mr-sm-2 w-100" data-search-input id="search-by" type="text" placeholder="Search">
            </form>

        

         <ul class="navbar-nav flex-column pt-3">
    <li data-nav-id="/hugo_tutorial/preface/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/preface/"><h6>Preface</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/table_of_content/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/table_of_content/"><h6>Table of Content</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter1/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter1/"><h6>Introduction to FastAPI</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter2/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter2/"><h6>The mWallet Project</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter3/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter3/"><h6>Identifying Routes</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter4/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter4/"><h6>Application services</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter5/" class="nav-item my-1 active
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter5/"><h6>The business domain entities and database layer</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter6/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter6/"><h6>Middleware in FastAPI</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter7/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter7/"><h6>Authorization and Authentication</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter8/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter8/"><h6>Testing</h6></a>
        
    </li>
    <li data-nav-id="/hugo_tutorial/chapter9/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/hugo_tutorial/chapter9/"><h6>Resources</h6></a>
        
    </li>
        </ul>
    </div>
</nav>


</div>
                <div class="docs-toc large order-lg-2 order-md-0 order-xs-1 col-12 col-lg-2 col-xl-2 position-sticky border-left"><div class="docs-toc">
	<nav id="TableOfContents">
  <ul>
    <li><a href="#defining-and-generating-schemas">Defining and Generating schemas</a></li>
    <li><a href="#defining-schemas">Defining Schemas</a>
      <ul>
        <li><a href="#generating-schemas">Generating schemas</a></li>
      </ul>
    </li>
    <li><a href="#sqlalchemy-and-the-object-relational-mapper-orm">SQLAlchemy and the Object Relational Mapper (ORM)</a>
      <ul>
        <li></li>
        <li><a href="#connecting-to-the-database">Connecting to the database</a></li>
        <li><a href="#crud-operations---eloquent-sqlalchemy-queries">CRUD operations - Eloquent SQLAlchemy queries</a></li>
        <li><a href="#threading-database-operations">Threading database operations</a></li>
        <li><a href="#database-transactions">Database transactions</a></li>
      </ul>
    </li>
  </ul>
</nav>
</div>
</div>
                <div class="main col-12 order-1 col-md-9 col-lg-10 col-xl-8 py-3">
                

<div class="d-flex flex-column">
    <h1 class="js-title">The business domain entities and database layer</h1>
    <div class="d-flex align-items-center">
        
    </div>
</div>

<hr>


<p>We had earlier identified some key resources for the application. In this Chapter, we will explore the use of pydantic models (generally called schemas), the SQLAlchemy Object Relational Mapper (ORM) and Core to manage database connections, queries, and storage. To build the right system, we need to ensure representations of users, systems, ideas or other concepts are well captured in our design. In some project teams, Entity Relational Diagrams (ERD) are used to capture and debug database model of the system in view. An ERD is a type of flow chart that shows how entities relate with one another in a system. Going back to our example in Chapter 2, we have listed certain resources and their corresponding operations. These resources are entities, such as Order, User, Asset, and Wallet.</p>
<p>üéì</p>
<blockquote>
<p>The term Resource is often used in describing objects, data or other information that is accessible via HTTP methods when using a REST API. Resource may be mapped to an actual database table through an Object Relational Mapper (ORM) such as SQLAlchemy.</p>
</blockquote>
<p>We may add other entities as is obtainable with a real-world cryptocurrency exchange. However, for simplicity, we will use our earlier named entities. We will not provide a detail ERD as that is beyond the scope of this book. We will, however, group these entities into logical categories mapped to modules in our database package named db. The db package will also provide utility functions to setup connection to our underlying database, define queries for performing CRUD operations, and manage sessions to databases using separate threads to speed database operations.</p>
<p>üéì</p>
<blockquote>
<p>A common pattern in REST application is to manage resource through defined operations that Create, Read, Update, or Delete a resource. Each of these operations are associated with a HTTP method.
Create is achieved using HTTP <code>POST</code> method with a successful response of <code>201</code>.
Update is achieved using HTTP <code>PUT</code> or <code>PATCH</code> method with a successful response of <code>200</code>, <code>201</code> or <code>204</code>
Read is achieved using HTTP <code>GET</code> method with a successful response of <code>200</code>.
Delete is achieved using HTTP <code>DELETE</code> method with a successful response of <code>200</code>, <code>202</code>, <code>204</code>.</p>
</blockquote>
<p>The FastAPI framework does not come with an inbuilt database ORM package like the Django framework. Instead, developers can use any database package of their choice. This flexibility allows developers to integrate and use packages they are already familiar with instead of learning a new ORM syntax. Before we dive deep into the database systems, let us further explore the pydantic model and how FastAPI validates data from users or send response to users via the pydantic model.</p>
<h2 id="defining-and-generating-schemas">Defining and Generating schemas</h2>
<p>Pydantic package provides data validation and management using Python type hint. The <code>BaseModel</code> class is the primary means by which other models can be created and then validated by pydantic at runtime. Arbitrary data can be used to initialize defined classes that extends the <code>BaseModel</code>. Pydantic will validate that the data received matches the defined data types of the selected model class. If the validation process fails, a validation error with feedback is raised. Data received from users via HTTP requests can be passed to a pydantic model and then validated as described. This simplifies the validation process and improves the overall performance of the web application. In the mWallet application, a collection of pydantic models were defined in the <code>schemas</code> package. For simplicity and ease of maintenance, schemas were designed to closely follow the database ORM classes for which they validate data.</p>
<p>In this book, we will call models that extends the pydantic BaseModel classes as schemas while models that extends the SQLAlchemy‚Äôs database ORM model simply as model. Where the word schema is not used, or its usage is considered ambiguous, or may imply something else, then the phrase pydantic model will be used. In essence, <code>ModelA</code> represents a database ORM class that is used to save data into <code>table_a</code>. <code>SchemaA</code> represents a schema that is used to validate data to ensure it matches definition that can be saved into database via <code>ModelA</code>. With this relationship between schema and model, we can explore the various schemas and later the models and associated operations of the mWallet application.</p>
<p><img src="model-schema-setup.png" alt="Model Schema relationship in mWallet"> <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<h2 id="defining-schemas">Defining Schemas</h2>
<p>We had defined our schemas to be types derived from pydantic <code>BaseModel</code> class. The class definition of this type can declare any arbitrary field type and will automatically inherit properties of the <code>BaseModel</code>. Some base properties inherited includes but not limited to the attributes shown below <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<table>
<thead>
<tr>
<th>Schema Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dict()</code></td>
<td>returns a dictionary of the fields defined in the schema with their corresponding values</td>
</tr>
<tr>
<td><code>json()</code></td>
<td>returns a JSON string representation of the schema <code>dict()</code> result</td>
</tr>
<tr>
<td><code>copy()</code></td>
<td>returns a shallow copy of the schema by default. If a deep copy is required, then set the keyword <code>deep=True</code>. Keywords <code>include</code>, <code>update</code>, and <code>exclude</code> can also be specified. The include parameter is a set of fields to keep in the returned result; the <code>update</code> is a dictionary of fields to change upon <code>copy</code>; <code>exclude</code> is a set of fields to remove from the result upon <code>copy</code></td>
</tr>
<tr>
<td><strong>Methods to parse data</strong></td>
<td></td>
</tr>
<tr>
<td><code>parse_obj()</code></td>
<td>a utility for loading any object into a model with error handling if the object is not a dictionary</td>
</tr>
<tr>
<td><code>parse_raw()</code></td>
<td>a utility for loading strings based on formats or patterns</td>
</tr>
<tr>
<td><code>parse_file()</code></td>
<td>Similar to <code>parse_raw()</code> but for file identified by path parameter. If the content_type of the file is not specified, then it is inferred from the file extension. This function passes content read from the file to the <code>parse_raw()</code> and then returns a schema if the operation is successful.</td>
</tr>
<tr>
<td><strong>Methods to export schema or create instances</strong></td>
<td></td>
</tr>
<tr>
<td><code>from_orm()</code></td>
<td>loads data into a model from an arbitrary class example a SQLAlchemy result</td>
</tr>
<tr>
<td><code>schema()</code></td>
<td>returns a dictionary representing the model as JSON Schema</td>
</tr>
<tr>
<td><code>schema_json()</code></td>
<td>returns a JSON string representation of schema() result</td>
</tr>
<tr>
<td><code>construct()</code></td>
<td>a class method for creating models without validating the data used</td>
</tr>
<tr>
<td><strong>Special pydantic model fields</strong></td>
<td></td>
</tr>
<tr>
<td><code>__fields_set__</code></td>
<td>Set of names of fields of the pydantic model set during class initialisation</td>
</tr>
<tr>
<td><code>__fields__</code></td>
<td>A dictionary of the pydantic model&rsquo;s fields</td>
</tr>
<tr>
<td><code>__config__</code></td>
<td>This attribute references the configuration class for the pydantic model. It is a general practise to use the class Config to define settings instead of directly modifying <code>__config__</code>.</td>
</tr>
</tbody>
</table>
<p>Now, lets start exploring some examples adapted from the mWallet project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> Enum
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel, Field
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderType</span>(Enum):
</span></span><span style="display:flex;"><span>    OPEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    CLOSED <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    SATISFIED <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    PARTIAL <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AssetType</span>(Enum):
</span></span><span style="display:flex;"><span>    BITCOIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    DASH <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    DOGECOIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    LITECOIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    NAIRA <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Order</span>(BaseModel):
</span></span><span style="display:flex;"><span>    order_type: OrderType <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    asset: AssetType <span style="color:#f92672">=</span> Field(default<span style="color:#f92672">=</span>AssetType<span style="color:#f92672">.</span>BITCOIN)
</span></span><span style="display:flex;"><span>    start: float <span style="color:#f92672">=</span> Field(<span style="color:#f92672">...</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The order start date and time represented as epoch time&#34;</span>)
</span></span><span style="display:flex;"><span>    expected_end: Optional[float] <span style="color:#f92672">=</span> Field(<span style="color:#66d9ef">None</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The order start date and time represented as epoch time&#34;</span>)
</span></span><span style="display:flex;"><span>    memo: Optional[str] <span style="color:#f92672">=</span> Field(<span style="color:#66d9ef">None</span>, max_length<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>)
</span></span></code></pre></div><p>We defined two enumerator types <code>AssetType</code> and <code>OrderType</code>. These enumerators are used to define the data types of asset and <code>order_type</code> in our <code>Order</code> schema. When initializing an instance of this schema, pydantic will expect a value of type <code>AssetType</code> to assign to the asset attribute and a value of type <code>OrderType</code> to assign to the <code>order_type</code> attribute. Also notice how the <code>Field</code> class is used to define attributes on the schema. A default value for a schema attribute can be set by assigning the keyword default to the value desired. Where <code>None</code> is used, the attribute is set as optional. Alternatively, the <code>Optional</code> type from Python typing package can be used. All attributes set to None are by default optional. When the first attribute of the Field class is an ellipsis (&hellip;) the attribute is marked as required. If the <code>Order</code> class is being initialized without a corresponding start data, then a <code>ValidationError</code> will be raised.
Our <code>Order</code> schema takes scalar types and nested <code>Enum</code> types. In some cases, we may have a more complex schema in which other schemas are used to define an attribute.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Preceding import statements excluded for simplicity</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> decimal <span style="color:#f92672">import</span> Decimal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> generate_transaction_ref
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Optional, Dict, List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transaction</span>(BaseModel):
</span></span><span style="display:flex;"><span>    order: Order
</span></span><span style="display:flex;"><span>    tranx_ref: str <span style="color:#f92672">=</span> Field(default<span style="color:#f92672">=</span>generate_transaction_ref, max_length(<span style="color:#ae81ff">256</span>))
</span></span><span style="display:flex;"><span>    tranx_id: str
</span></span><span style="display:flex;"><span>    inputs: str
</span></span><span style="display:flex;"><span>    outputs: str
</span></span><span style="display:flex;"><span>    confirmations: int
</span></span><span style="display:flex;"><span>    meta: Optional[Dict] 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Config</span>:
</span></span><span style="display:flex;"><span>        arbitrary_types_allowed <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        orm_mode <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CryptoAddress</span>(BaseModel):
</span></span><span style="display:flex;"><span>    address: str <span style="color:#f92672">=</span> Field(<span style="color:#f92672">...</span>, max_length(<span style="color:#ae81ff">64</span>))
</span></span><span style="display:flex;"><span>    network: str <span style="color:#f92672">=</span> Field(max_length(<span style="color:#ae81ff">32</span>))
</span></span><span style="display:flex;"><span>    is_default: bool <span style="color:#f92672">=</span> Field(default<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>) 
</span></span><span style="display:flex;"><span>    address_balance: Decimal
</span></span><span style="display:flex;"><span>    label: Optional[str] <span style="color:#f92672">=</span> Field(<span style="color:#66d9ef">None</span>, max_length(<span style="color:#ae81ff">50</span>))
</span></span><span style="display:flex;"><span>    description: Optional[str] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserAddress</span>(CryptoAddress):    
</span></span><span style="display:flex;"><span>    account_number: str
</span></span><span style="display:flex;"><span>    account_key: bytes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Config</span>:        
</span></span><span style="display:flex;"><span>        orm_mode <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span></code></pre></div><p>We now introduce a <code>Transaction</code>, <code>CryptoAddress</code>, and <code>UserAddress</code> schemas. The <code>Transaction</code> schema models a blockchain transaction with attributes to capture the blockchain transaction hash as <code>tranx_id</code>, the input address (sender) involved in the blockchain transaction, the output address (receiver) in the blockchain transaction, and number of confirmations in the blockchain. Any other transaction information may be captured as a mapping of key-value pair using the meta attribute. We equally define a <code>CryptoAddress</code> schema to capture a given cryptocurrency address. We will not model a HD wallet or multikey wallet as an address will serve the purpose of our exchange. Notice our UserAddress extends the CryptoAddress schema. Pydantic models like other Python classes can be extended or composed in other classes. In the <code>Transaction</code> schema we have an attribute order of type <code>Order</code> schema. If arbitrary types are used in our schema, this information needs to be passed to the underlying validator to enable proper parsing of data. We can configure the needed attribute or flag for this purpose using the class <code>Config</code> attribute <code>arbitrary_type_allowed = True</code>. We can also define an orm_mode flag using the Config class as shown in the <code>UserAddress</code> schema. This will notify pydantic that our schema can receive data from a Python object that is possibly an instance of a database ORM model. When the <code>orm_mode</code> is enabled, the <code>from_orm</code> method can be used to parse an instance of our ORM into an instance of our schema.</p>
<h3 id="generating-schemas">Generating schemas</h3>
<p>In some scenarios, it may be desirable to dynamically generate a pydantic model that closely matches our defined database. As an example, supposing we have an existing database that interfaces with some legacy code. We are required to build a modern web API using FastAPI and not required to modify the underlying database. For our scenario, we are also required to use SQLAlchemy as this already works well for the existing code base. With this in view, we could spend hours writing codes that define our schemas or we can rely on the power of SQLAlchemy and the Python type class to generate the schemas we need. Let us consider the later approach as this will enable us quickly to deliver on our project.</p>
<p>The SQLAlchemy has feature that supports connecting to a database and loading ORM classes from the defined database connection. From this feature we can generate and save to file a set of model classes that closely map to our underlying database tables. With our models now in place, let us generate schemas. We will rely on the <code>type</code> metaclass to generate abstract classes that extends pydantic <code>BaseModel</code>. We defined this process in the function <code>make_schemas</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> stringcase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> TypeVar, Dict, Optional, List, Tuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel, BaseConfig
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> db <span style="color:#f92672">import</span> Base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ModelT <span style="color:#f92672">=</span> TypeVar(<span style="color:#e6db74">&#39;ModelT&#39;</span>, bound<span style="color:#f92672">=</span>Base)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_schema</span>(model: ModelT, parents: List <span style="color:#f92672">|</span> Tuple <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, defaults: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, name: str <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    table_columns <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>__table__<span style="color:#f92672">.</span>columns
</span></span><span style="display:flex;"><span>    table_fields <span style="color:#f92672">=</span> table_columns<span style="color:#f92672">.</span>keys()
</span></span><span style="display:flex;"><span>    table_schema <span style="color:#f92672">=</span> table_columns<span style="color:#f92672">.</span>items()
</span></span><span style="display:flex;"><span>    annotations <span style="color:#f92672">=</span> {x: Optional[y<span style="color:#f92672">.</span>type<span style="color:#f92672">.</span>python_type] <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> table_schema}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> defaults:
</span></span><span style="display:flex;"><span>        defaults <span style="color:#f92672">=</span> {x: y <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> defaults<span style="color:#f92672">.</span>items() <span style="color:#66d9ef">if</span> x <span style="color:#f92672">in</span> table_fields}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        defaults <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> name:
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> stringcase<span style="color:#f92672">.</span>pascalcase(name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> stringcase<span style="color:#f92672">.</span>pascalcase(model<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;Schema&#39;</span>)
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> BaseConfig
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>arbitrary_types_allowed <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    config<span style="color:#f92672">.</span>orm_mode <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    values <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;__annotations__&#39;</span>: annotations, <span style="color:#e6db74">&#39;Config&#39;</span>: config}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    values<span style="color:#f92672">.</span>update(defaults)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> parents:
</span></span><span style="display:flex;"><span>        bases <span style="color:#f92672">=</span> (BaseModel,)
</span></span><span style="display:flex;"><span>        allowed <span style="color:#f92672">=</span> (x <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> parents <span style="color:#66d9ef">if</span> issubclass(x, BaseModel))
</span></span><span style="display:flex;"><span>        bases <span style="color:#f92672">+=</span> tuple(allowed)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        bases <span style="color:#f92672">=</span> (BaseModel,)
</span></span><span style="display:flex;"><span>    dyn_schema <span style="color:#f92672">=</span> type(name, bases, values)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> dyn_schema
</span></span></code></pre></div><p>The <code>make_schema</code> function takes a SQLAlchemy ORM mapper class, <code>ModelT</code>, a list of base classes which the final schema should extend, a dictionary of default values the schema should have, and the name of the final schema being generated. Using the model class, we retrieve a set of table columns which are defined as attributes on the model class. This is done by calling the mapper property <code>__table__</code> and then calling the columns property of the table object returned by <code>__table__</code>. From the returned list of columns, we can retrieved only the column names by calling the <code>keys()</code> and the column definitions by calling the <code>items()</code> method. Now we have both names for the underlying table columns and the type of data the column should store. We can use this information to define the fields of our schema and the datatype which should be assigned to a given field. We define an <code>annotations</code> variable by using Python dictionary comprehension. We can further process the default values for the schema passed to the <code>make_schema</code> function. If the defaults dictionary is not empty, we update it by taking only keys that have same names as our table columns - as we would want our final schema to be identical to our model for simplicity.  This <code>defaults</code> dictionary is then combined with the <code>annotations</code> dictionary to generate a dictionary of all fields and configuration with their corresponding values. Notice we programmatically set the <code>orm_mode</code> flag in our configuration dictionary. By using the Python <code>type</code> metaclass, we can generate a new class that extends pydantic <code>BaseModel</code>. The <code>type</code> class can take three parameters namely the name of the new class being generated, the bases which is a list of parents to inherit from, the default values of member attributes or fields of the newly generated class. Once these parameters are defined, we can return a schema class that extends <code>BaseModel</code> and any other schema specified via parents parameter. Our schema class will also have attributes with values as specified by <code>defaults</code>. The datatype for each field will be set by the <code>annotations</code> dictionary and each datatype will match the specified Python datatype used in defining our SQLAlchemy models.</p>
<h4 id="-further-read--python-type-and-metaclass">üìö Further Read ‚Äì Python type and metaclass</h4>
<blockquote>
<p>Mataclass is a template by which other classes can be defined. It is a blueprint that describes how other classes can be constructed. A class definition will create a class name, a dictionary of class attributes, and list of parent classes. The metaclass is used to manage the creation of these components of a class and manage the creation of the class through the <code>__new__</code> method. The class <code>__init__</code> method can be used to initialize instances of a class. The <code>__init__</code> is not a constructor as obtainable in languages like Java. Rather, it is an instance method used to set instance attribute after being created by the metaclass <code>__new__</code> method.
Metaclasses are to classes as classes are to objects. Metaclasses in Python are used to achieve a design goal in which base classes can constrain the behaviour of their children‚Äôs classes.
üìñ <a href="https://realpython.com/python-metaclasses/">Real Python Tutorial on metaclasses</a>
üì∫ <a href="https://www.youtube.com/watch?v=cKPlPJyQrt4&amp;pp=ygUScHl0aG9uIG1ldGFjbGFzc2Vz">Example video on mataclasses from YouTube</a></p>
</blockquote>
<p>In the mWallet application, the make_schema class is used to specify the response_model variable dynamically if we have the name of the target ORM model.</p>
<h2 id="sqlalchemy-and-the-object-relational-mapper-orm">SQLAlchemy and the Object Relational Mapper (ORM)</h2>
<p>SQLAlchemy is a SQL toolkit and Object Relational Mapper (ORM) that is flexible, extensible, and equally powerful. SQLAlchemy can be seen as a database domain-specific language written in Python as it allows developers to write complex SQL expressions without the need of writing raw SQL commands in many scenarios.  SQLAlchemy is presented as two distinct APIs, namely the Core and the ORM. The ORM builds on the Core and in many scenarios, developers can manage all database services using the core without any ORM feature.</p>
<p>SQLAlchemy Core as the name implies is the foundation part of the system that provides database management and tooling. It also provides a rich SQL Expression Language that allows for building queries by combining various constructs that may include SQL functions, keywords, queries, or command. The Core library provides tools for managing connectivity to a database, interacting with database queries and results, and programmatic construction of SQL statements.
The SQLAlchemy ORM provides object relational mapping support allowing user have access to Python model classes that are mapped to database tables. The ORM extends Core features like SQL Expression Language and a session object to save changes to the database.</p>
<p>We will explore some aspects of the Core API and see how to use this in managing database records for the mWallet application.</p>
<h4 id="-further-read--sqlalchemy-features">üìö Further Read ‚Äì SQLAlchemy features</h4>
<blockquote>
<p>SQLAlchemy boasts of several features that sets it apart from other ORMs written in Python. Some key features are:</p>
<ul>
<li>Database operations can be performed without an ORM</li>
<li>SQLAlchemy is a matured, robust architecture with high performance</li>
<li>SQLAlchemy conforms with multiple relational databases‚Äô requirements</li>
<li>The framework is non-opinionated SQL toolkit written fully in Python</li>
<li>It adopts the unit of work pattern which batches pending SQL operations (insert, update, delete etc.) into queues and flushes it at once. This makes if fully transactional and safe with high efficiency.</li>
<li>SQLAlchemy is modular and extensible
For more information on the features of SQLAlchemy see <a href="https://www.sqlalchemy.org/features.html">documentation here</a> .</li>
</ul>
</blockquote>
<h3 id="connecting-to-the-database">Connecting to the database</h3>
<p>The tool for connecting to a relational database system is provided by the SQLAlchemy Core. We must first establish a connection to the database before using SQLAlchemy Core to access it.  An <code>Engine</code> class is used to set up and manage a database connection and database specific dialect. To create an <code>Engine</code> entail passing a URL connection string to sqlalchemy&rsquo;s <code>create_engine</code> function. It is important to note that though an <code>Engine</code> instance is returned by the <code>create_engine</code> function, an actual database connection is not established until the <code>Engine.connect()</code> or <code>Engine.execute()</code> methods are called either directly or through a <code>session</code> object associated with the <code>Engine</code> instance. In effect, the <code>Engine</code> has a lazy initialization behaviour.</p>
<p>A database URL connection string follows comprises of segments that specifies the database dialect, the driver, datasource name or username and password.</p>
<p><img src="connection-url.png" alt="DB Connection URL"> <sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<p>In some instances, a the sqlalchemy URL class can be used to generate an URL object that can be used in place of a connection string. This is desirable where username or password fragment of a connection string may have forbidden characters, for example, <code>@</code> or <code>-</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> URL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine_a <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;postgresql+psycopg2://fred:randompassword@localhost:5432/mWallet&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url_object <span style="color:#f92672">=</span> URL<span style="color:#f92672">.</span>create(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;postgresql+psycopg2&#34;</span>,
</span></span><span style="display:flex;"><span>    username<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;fred&#34;</span>,
</span></span><span style="display:flex;"><span>    password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;random-password&#34;</span> <span style="color:#75715e"># An unacceptable character in password. This will raise an error if using connection string</span>
</span></span><span style="display:flex;"><span>    host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;localhost&#34;</span>,
</span></span><span style="display:flex;"><span>    database<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mWallet&#34;</span>,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine_b <span style="color:#f92672">=</span> create_engine(url_object)
</span></span></code></pre></div><p>We initialized two engines, <code>engine_a</code> and <code>engine_b</code> using the <code>create_engine</code> function. In the first case, a string parameter was used with <code>create_engine</code> while a <code>url_object</code> was used in the later case. Both <code>Engine</code> instances are valid connections to the underlying database named mWallet. Instances of the <code>Engine</code> class (for example, <code>engine_a</code> and <code>engine_b</code>) can be passed to a <code>Session</code> object to work with the SQL Expression Language or ORM. Also, note that both <code>engine_a</code> and <code>engine_b</code> are defined as global variables.</p>
<p>üîç</p>
<blockquote>
<p>SQLAlchemy provides multiple methods in producing an Engine instance aside the create_engine function. Other functions are the engine_from_config and create_mock_engine.
For more information on database connections, see the <a href="https://docs.sqlalchemy.org/en/20/core/engines.html#engine-creation-api">SQLAlchemy documentation</a></p>
</blockquote>
<p>An instance of the <code>Engine</code> class could be defined as a global object to make it readily accessible to other modules or packages. So, let‚Äôs do some housekeeping. We will define a <code>db</code> package in which all database services will be managed. This package will access our connection string stored as an environment variable. It is a good practise to have database connection string and similar credentials as environment variables using a <code>.env</code> file which is not directly accessible in code. Also, ensure that <code>.env</code> file or other files used to store environment variables are not added to your code repository or version control tool.</p>
<h4 id="further-reading---sqlalchemy-engine">Further Reading - SQLAlchemy Engine</h4>
<blockquote>
<p><img src="sqla_engine_arch.png" alt="SQLAlchemy Engine Architecture"> <sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup>
The SQLAlchemy Engine is the starting point of the all database operations defined in the SQLAlchemy DBAPI. Actual database operations and connection pool are managed by an Engine instance.
üìñ<a href="https://docs.sqlalchemy.org/en/20/core/connections.html#basic-usage"> Explaining how to work with SQLAlchemy Engine and Connections</a>
üìñ  <a href="https://docs.sqlalchemy.org/en/20/core/engines.html">SQLAlchemy Engine configuration</a>
üìñ  <a href="https://docs.sqlalchemy.org/en/20/dialects/index.html">SQLAlchemy database dialect</a></p>
</blockquote>
<p>In the mWallet application, all databse services for setting up connections, and defining database models are managed through the <code>db</code> package. An <code>engine</code> instance is defined as a global variable which can be injected across various functions when needed as only a single connection is needed per time for each user session.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime <span style="color:#66d9ef">as</span> dt
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Any, Type, Dict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> sessionmaker
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bitmast_mwallet.settings <span style="color:#f92672">import</span> DB_CONNECTION_URL
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(DB_CONNECTION_URL, echo<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>Session <span style="color:#f92672">=</span> sessionmaker(autocommit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, autoflush<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_db</span>():
</span></span><span style="display:flex;"><span>    Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>create_all(bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">drop_db</span>():
</span></span><span style="display:flex;"><span>    Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>drop_all(engine)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Session()
</span></span></code></pre></div><p>In our setup we introduced the <code>sessionmaker</code> function. This function is used to generate <code>Session</code> objects. In our scenario, we will be using the same database configuration hence we can provide these configuration details as parameters to the <code>sessionmaker</code>. Keyword parameters that are used for <code>Session.configure</code> can be passed to the <code>sessionmaker</code> function to generate a <code>Session</code> with the set configuration. In our example, we pass three parameters: <code>autocommit</code> which is a boolean specifying if database transactions should be automatically saved even if the session <code>commit()</code> method is not called; <code>autoflush </code> which is a boolean specifying if transactions should be automatically flushed; <code>bind</code> variable which specifies what engine is used to manage the underlying database and by implication, the engine to which all transactions will be performed.</p>
<p>We also defined a <code>Base</code> variable using the <code>declarative_base()</code> function. This function call will generate a base class from which we can derive model classes that we can use to describe underlying database tables declaratively. The <code>declarative_base</code> function can be called with keyword argument to further customise the target object used for mapping models to database table. However, for our use case, the default values are suitable. All model classes derived from our Base object will implicitly inherit the same mapper object that connects our model to the underlying database tables.</p>
<p>We can further organize ORM models with similar properties to share the same <code>Base</code> class and other parents. This approach will enable us customize table structure and behaviour using model classes or mixins that our final models will inherit from. For instance, all tables with a primary key field represented as an integer can inherit from the same parent mixin and tables with foreign key linked to a user record can inherit this feature from a mixin with this characteristic. Tables which support a given search behaviour can inherit from a search mixin. SQLAlchemy provides us tools to achieve this easily through the <code>declared_attr</code> and <code>declarative_mixin</code> decorators.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime <span style="color:#66d9ef">as</span> dt
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Any, Type, Dict
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> stringcase
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> Depends
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> Column, String, Integer, Unicode, ForeignKey
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine, DateTime, inspect
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.dialects.postgresql <span style="color:#f92672">import</span> UUID
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.declarative <span style="color:#f92672">import</span> declarative_base, declared_attr
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> sessionmaker, declarative_mixin, Mapped, mapped_column, relationship
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bitmast_mwallet.settings <span style="color:#f92672">import</span> DB_CONNECTION_URL
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> generate_slug, current_timezone
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(DB_CONNECTION_URL, echo<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>Session <span style="color:#f92672">=</span> sessionmaker(autocommit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, autoflush<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_db</span>():
</span></span><span style="display:flex;"><span>    Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>create_all(bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">drop_db</span>():
</span></span><span style="display:flex;"><span>    Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>drop_all(engine)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Session()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@declarative_mixin</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TableMixin</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@declared_attr.directive</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__tablename__</span>(cls):
</span></span><span style="display:flex;"><span>        name <span style="color:#f92672">=</span> cls<span style="color:#f92672">.</span>__name__
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> stringcase<span style="color:#f92672">.</span>lowercase(stringcase<span style="color:#f92672">.</span>snakecase(name))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __int__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> inspect(self)<span style="color:#f92672">.</span>mapper<span style="color:#f92672">.</span>column_attrs:
</span></span><span style="display:flex;"><span>            setattr(self, c<span style="color:#f92672">.</span>key, kwargs[c<span style="color:#f92672">.</span>key])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_pydantic_schema</span>(self, model: Type[Base], transpose: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Any:        
</span></span><span style="display:flex;"><span>        fields <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>as_dict()
</span></span><span style="display:flex;"><span>        fields<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#39;Config.arbitrary_types_allowed&#39;</span>: <span style="color:#66d9ef">True</span>})
</span></span><span style="display:flex;"><span>        fields<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#39;__annotations__&#39;</span>: self<span style="color:#f92672">.</span>__annotations__})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> hasattr(model, <span style="color:#e6db74">&#39;__name__&#39;</span>):
</span></span><span style="display:flex;"><span>            name <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>__name__
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DynamicSchema&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> transpose:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># set annotations using the schema</span>
</span></span><span style="display:flex;"><span>            fields <span style="color:#f92672">=</span> {x: fields<span style="color:#f92672">.</span>get(y, <span style="color:#66d9ef">None</span>) <span style="color:#66d9ef">for</span> x, y <span style="color:#f92672">in</span> transpose<span style="color:#f92672">.</span>items() <span style="color:#66d9ef">if</span> y <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        schema <span style="color:#f92672">=</span> type(name, bases<span style="color:#f92672">=</span>(BaseModel,), dict<span style="color:#f92672">=</span>fields)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> schema
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@declarative_mixin</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseTableMixin</span>:
</span></span><span style="display:flex;"><span>    uuid: Mapped[UUID] <span style="color:#f92672">=</span> mapped_column(UUID, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    slug: Mapped[str] <span style="color:#f92672">=</span> mapped_column(String(<span style="color:#ae81ff">128</span>), index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, default<span style="color:#f92672">=</span>generate_slug)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">search</span>(cls, session: Any <span style="color:#f92672">=</span> Depends(get_session), <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> session<span style="color:#f92672">.</span>begin():
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> session<span style="color:#f92672">.</span>query(cls)<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_asdict</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> {c<span style="color:#f92672">.</span>key: getattr(self, c<span style="color:#f92672">.</span>key) <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> inspect(self)<span style="color:#f92672">.</span>mapper<span style="color:#f92672">.</span>column_attrs}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __eq__(self, other):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> hasattr(self, <span style="color:#e6db74">&#39;id&#39;</span>) <span style="color:#f92672">and</span> hasattr(other, <span style="color:#e6db74">&#39;id&#39;</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@declarative_mixin</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PrimaryKeyMixin</span>:
</span></span><span style="display:flex;"><span>    id: Mapped[int] <span style="color:#f92672">=</span> mapped_column(Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __eq__(self, other):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>__class__<span style="color:#f92672">.</span>__name__ <span style="color:#f92672">and</span> self<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> other<span style="color:#f92672">.</span>id
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@declarative_mixin</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserIdMixin</span>:
</span></span><span style="display:flex;"><span>    usid <span style="color:#f92672">=</span> mapped_column(String(<span style="color:#ae81ff">32</span>), unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> mapped_column(Integer, ForeignKey(<span style="color:#e6db74">&#39;user.id&#39;</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@declared_attr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@classmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">user</span>(cls):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> relationship(<span style="color:#e6db74">&#39;User&#39;</span>, cascade<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;all, delete&#39;</span>)
</span></span></code></pre></div><p>We define a <code>TableMixin</code>, <code>BaseTableMixin</code>, <code>PrimaryKeyMixin</code>, and <code>UserIdMixin</code>. These classes define different features we may want to pass unto our model classes. The <code>TableMixin</code> defines a <code>__tablename__</code> attribute which converts our class name to a snakecase (snake_case) string value. This parameter is used to set the actual table name created in our database during migration. The <code>BaseTableMixin</code> provides three methods that allows us to search a table using keyword arguments provided as a dictionary; an <code>_asdict</code> method that parse our ORM instance to Python dictionary having attributes as keys and their respective value as values; an equality check method achieved by overridden the default <code>__eq__</code> method.</p>
<p>üîç</p>
<blockquote>
<p>Overriding special or dunder (double underscore) methods in Python should be done with caution. These methods are often associated with the root object or a parent metaclass. Only when one is very sure of the desired outcome of overridden such method should such be done. The example in this book is simply for demonstration purposes and not a recommendation for the reader.</p>
</blockquote>
<p>The <code>PrimaryKeyMixin</code> defines an id attribute that is used as primary key for any model inheriting from this class. SQLAlchemy supports various database dialects and features such as composite primary keys. Classes inheriting from <code>PrimaryKeyMixin</code> can define other primary key fields which will be converted to a composite primary key upon migration. The <code>UserIdMixin</code> uses the <code>declared_attr</code> decorator to return a relationship object which links the derived models of this class to a <code>User</code> model via the <code>user_id</code> attribute. In effect, the resulting table will have a <code>user_id</code> that references the user table upon migration.</p>
<p>These classes can be used to define various ORM classes declaratively.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Any
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> Enum
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> Enum <span style="color:#66d9ef">as</span> DbEnum, Numeric, String, LargeBinary, ForeignKey, Integer, Text, SmallInteger, Boolean, \
</span></span><span style="display:flex;"><span>    UniqueConstraint
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.dialects.postgresql <span style="color:#f92672">import</span> JSON
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> mapped_column, Mapped, relationship
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> db <span style="color:#f92672">import</span> Base, BaseTableMixin, UserIdMixin, TableMixin, PrimaryKeyMixin, TimestampMixin
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> generate_transaction_ref
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderType</span>(Enum):
</span></span><span style="display:flex;"><span>    OPEN <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    CLOSED <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    SATISFIED <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    PARTIAL <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AssetType</span>(Enum):
</span></span><span style="display:flex;"><span>    BITCOIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    DASH <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    DOGECOIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    LITECOIN <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    NAIRA <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Order</span>(TableMixin, PrimaryKeyMixin, UserIdMixin, BaseTableMixin, Base):
</span></span><span style="display:flex;"><span>    order_type: Mapped[OrderType] <span style="color:#f92672">=</span> mapped_column(DbEnum(OrderType))
</span></span><span style="display:flex;"><span>    asset: Mapped[AssetType] <span style="color:#f92672">=</span> mapped_column(DbEnum(AssetType))
</span></span><span style="display:flex;"><span>    start: Mapped[float] <span style="color:#f92672">=</span> mapped_column(Numeric)
</span></span><span style="display:flex;"><span>    expected_end: Mapped[float] <span style="color:#f92672">=</span> mapped_column(Numeric)
</span></span><span style="display:flex;"><span>    memo: Mapped[str] <span style="color:#f92672">=</span> mapped_column(String(<span style="color:#ae81ff">128</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransactionKey</span>(TableMixin, UserIdMixin, PrimaryKeyMixin, BaseTableMixin, Base):
</span></span><span style="display:flex;"><span>    signature: Mapped[bytes] <span style="color:#f92672">=</span> mapped_column(LargeBinary)
</span></span><span style="display:flex;"><span>    pubkey: Mapped[bytes] <span style="color:#f92672">=</span> mapped_column(LargeBinary)
</span></span><span style="display:flex;"><span>    start: Mapped[float] <span style="color:#f92672">=</span> mapped_column(Numeric)
</span></span><span style="display:flex;"><span>    end: Mapped[float] <span style="color:#f92672">=</span> mapped_column(Numeric)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transaction</span>(TableMixin, PrimaryKeyMixin, BaseTableMixin, Base):
</span></span><span style="display:flex;"><span>    order_id: Mapped[int] <span style="color:#f92672">=</span> mapped_column(Integer, ForeignKey(<span style="color:#e6db74">&#39;order.id&#39;</span>))
</span></span><span style="display:flex;"><span>    order: Mapped[Order] <span style="color:#f92672">=</span> mapped_column(<span style="color:#e6db74">&#39;Order&#39;</span>)
</span></span><span style="display:flex;"><span>    tranx_ref: Mapped[str] <span style="color:#f92672">=</span> mapped_column(String(<span style="color:#ae81ff">256</span>), default<span style="color:#f92672">=</span>generate_transaction_ref)
</span></span><span style="display:flex;"><span>    tranx_id: Mapped[str] <span style="color:#f92672">=</span> mapped_column(String(<span style="color:#ae81ff">256</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    inputs: Mapped[str] <span style="color:#f92672">=</span> mapped_column(Text)
</span></span><span style="display:flex;"><span>    outputs: Mapped[str] <span style="color:#f92672">=</span> mapped_column(Text)
</span></span><span style="display:flex;"><span>    confirmations: Mapped[int] <span style="color:#f92672">=</span> mapped_column(SmallInteger)
</span></span><span style="display:flex;"><span>    pubkey: Mapped[bytes] <span style="color:#f92672">=</span> mapped_column(LargeBinary)
</span></span><span style="display:flex;"><span>    meta: Mapped[Any] <span style="color:#f92672">=</span> mapped_column(JSON)
</span></span></code></pre></div><p>We define an <code>Order</code> and <code>Transaction</code> model which both extends earlier defined mixins. Attributes of these models are defined with annotated type hints. For example, the asset attribute of <code>Order</code> has a data type of <code>AssetType</code> which is an enumeration of cryptocurrencies. The type hint is declared using the <code>Mapped</code> class as specified in SQLAlchemy 2.0.x. The <code>Mapped</code> class provides information for type checkers like mypy so that ORM attributes managed by the base mapper have appropriate type. The column type associated with each model attribute is declared using the <code>mapped_column</code> function. Earlier version of SQLAlchemy (1.4 or earlier)  uses the <code>Column</code> class to declare table columns as attributes of the model. The <code>mapped_column</code> still returns a <code>Column</code> object and takes keyword arguments that is used in <code>Column</code> initialization.</p>
<p>We can expand further on our code to define other relevant classes that meets our minimum viable product. Once all our classes are in place, we can migrate our models to actual database tables. A common migration tool used with SQLAlchmey is the <code>alembic</code> package developed by the SQLAlchemy team. This can be installed using <code>pip</code> command. A detail tutorial on migration is beyond the scope of this book. However, readers can visit the official website of <a href="https://alembic.sqlalchemy.org/en/latest/">alembic</a> for more information on using alembic.</p>
<h4 id="-further-read---sqlalchemy-alembic">üìö Further Read - SQLAlchemy alembic</h4>
<blockquote>
<p>Alembic uses SQLAlchemy as an underlying engine to manage database changes and other DDL operations like create, alter, truncate, and drop table.
For more information on database connections, see the alembic documentation and tutorial
üìñ <a href="https://alembic.sqlalchemy.org/en/latest/index.html">Alembic documentation</a>
üìñ <a href="https://alembic.sqlalchemy.org/en/latest/tutorial.html">Alembic tutorial</a></p>
</blockquote>
<h3 id="crud-operations---eloquent-sqlalchemy-queries">CRUD operations - Eloquent SQLAlchemy queries</h3>
<p>We have defined a couple of models using SQLAlchemy ORM. We now have a Python bridge with our database and can send and retrieve data from our database using this bridge. In most web applications, we will be performing operations such as create data, retrieve data, update data, and delete data ‚Äì CRUD operations. SQLAlchemy Core and ORM provides us with expressive query language by which we can perform SQL Data Manipulation Language (DML) with commands such as INSERT, UPDATE, DELETE; Transaction Control Language (TCL) with commands such as COMMIT; Data Query Language with SELECT command and lots more. We can define functions to execute CRUD operations and other operations across multiple models as needed by our application. For example, we can have a function that will enable us to create arbitrary records of any model with a set of values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> IntEnum
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> TypeVar, Type, Mapping, Union, Any, Dict, Sequence, Tuple, List
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> uuid <span style="color:#f92672">import</span> UUID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel <span style="color:#66d9ef">as</span> PydanticModel
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> inspect, insert, update
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.engine <span style="color:#f92672">import</span> Result, Row
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.declarative <span style="color:#f92672">import</span> declarative_base
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> Session, Query
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bitmast_mwallet <span style="color:#f92672">import</span> settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ModelT <span style="color:#f92672">=</span> TypeVar(<span style="color:#e6db74">&#34;ModelT&#34;</span>, bound<span style="color:#f92672">=</span>Base)
</span></span><span style="display:flex;"><span>Queryset <span style="color:#f92672">=</span> TypeVar(<span style="color:#e6db74">&#34;Queryset&#34;</span>, bound<span style="color:#f92672">=</span>Query)
</span></span><span style="display:flex;"><span>QueryResult <span style="color:#f92672">=</span> TypeVar(<span style="color:#e6db74">&#34;QueryResult&#34;</span>, bound<span style="color:#f92672">=</span>Result)
</span></span><span style="display:flex;"><span>ResultRow <span style="color:#f92672">=</span> TypeVar(<span style="color:#e6db74">&#34;ResultRow&#34;</span>, bound<span style="color:#f92672">=</span>Row)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Operation</span>(IntEnum):
</span></span><span style="display:flex;"><span>    CREATE <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    READ <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>    UPDATE <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    DELETE <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    LIST <span style="color:#f92672">=</span> <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_retrieve</span>(model_class: Type[ModelT], identifier: Union[int, str, UUID], skip: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, limit: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, filter_by: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, exclude: List <span style="color:#f92672">|</span> Tuple <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> Session(settings<span style="color:#f92672">.</span>DB_ENGINE) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(identifier, UUID):
</span></span><span style="display:flex;"><span>            identifier <span style="color:#f92672">=</span> str(identifier)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> filter_by:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>                model_class<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> identifier)<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>filter_by)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span>filter(
</span></span><span style="display:flex;"><span>                model_class<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> identifier)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> queryset_range(queryset, skip, limit)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> parse_to_dict(result, exclude<span style="color:#f92672">=</span>exclude)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_list</span>(model_class: Type[ModelT], skip: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, limit: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, filter_by: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>               exclude: List <span style="color:#f92672">|</span> Tuple <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> Session(settings<span style="color:#f92672">.</span>DB_ENGINE) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> filter_by:
</span></span><span style="display:flex;"><span>                qs <span style="color:#f92672">=</span> queryset_range(queryset, skip, limit, as_queryset<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>                rs <span style="color:#f92672">=</span> qs<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>filter_by)<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                rs <span style="color:#f92672">=</span> queryset_range(queryset, skip, limit)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> parse_to_dict(rs, exclude<span style="color:#f92672">=</span>exclude)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_bulk_create</span>(instance: Union[List[Type[ModelT]], Tuple[Type[ModelT]]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> Session(settings<span style="color:#f92672">.</span>DB_ENGINE) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(instance, (List, Tuple)):
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>add_all(instance)
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> parse_to_dict(instance)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_create</span>(instance: Union[Type[ModelT], List[Type[ModelT]], Tuple[Type[ModelT]]] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, data: Mapping <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>                 model: Type[ModelT] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, exclude: List <span style="color:#f92672">|</span> Tuple <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> Session(settings<span style="color:#f92672">.</span>DB_ENGINE) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> instance:
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>add(instance)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> data <span style="color:#f92672">and</span> model:
</span></span><span style="display:flex;"><span>            instance <span style="color:#f92672">=</span> model(<span style="color:#f92672">**</span>data)
</span></span><span style="display:flex;"><span>            session<span style="color:#f92672">.</span>add(instance)
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>flush()
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>refresh(instance, (<span style="color:#e6db74">&#39;id&#39;</span>,))
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> parse_to_dict(instance, exclude<span style="color:#f92672">=</span>exclude)
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_update</span>(model_class: Type[ModelT], data: Mapping <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, identifier: Union[int, str, UUID] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>                 filter_by: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, exclude: List <span style="color:#f92672">|</span> Tuple <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Tuple[Sequence, int]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> Session(settings<span style="color:#f92672">.</span>DB_ENGINE) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> identifier <span style="color:#f92672">and</span> filter_by:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span> \
</span></span><span style="display:flex;"><span>                filter(model_class<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> identifier)<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>filter_by)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>                updated <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>update(values<span style="color:#f92672">=</span>data, synchronize_session<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fetch&#39;</span>)
</span></span><span style="display:flex;"><span>                rs <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>                updates <span style="color:#f92672">=</span> parse_to_dict(rs, exclude<span style="color:#f92672">=</span>exclude)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> updates, updated
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> identifier <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> filter_by:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span> \
</span></span><span style="display:flex;"><span>                filter(model_class<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> identifier)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>                updated <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>update(values<span style="color:#f92672">=</span>data, synchronize_session<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fetch&#39;</span>)
</span></span><span style="display:flex;"><span>                rs <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>                updates <span style="color:#f92672">=</span> parse_to_dict(rs, exclude<span style="color:#f92672">=</span>exclude)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> updates, updated
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> filter_by <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> identifier:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>filter_by)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>                updated <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>update(values<span style="color:#f92672">=</span>data, synchronize_session<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fetch&#39;</span>)
</span></span><span style="display:flex;"><span>                rs <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>all()
</span></span><span style="display:flex;"><span>                updates <span style="color:#f92672">=</span> parse_to_dict(rs, exclude<span style="color:#f92672">=</span>exclude)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> updates, updated
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">model_destroy</span>(model_class: Type[ModelT], identifier: Union[str, int, UUID] <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, filter_by: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> \
</span></span><span style="display:flex;"><span>        Union[<span style="color:#66d9ef">None</span>, int]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> Session(settings<span style="color:#f92672">.</span>DB_ENGINE) <span style="color:#66d9ef">as</span> session:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> identifier <span style="color:#f92672">and</span> filter_by:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span> \
</span></span><span style="display:flex;"><span>                filter(model_class<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> identifier)<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>filter_by)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>                deleted <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>delete(synchronize_session<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fetch&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> deleted
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> identifier <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> filter_by:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span>filter(model_class<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> identifier)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>                deleted <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>delete(synchronize_session<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fetch&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> deleted
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> filter_by <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> identifier:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(model_class)<span style="color:#f92672">.</span>filter_by(<span style="color:#f92672">**</span>filter_by)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> queryset:
</span></span><span style="display:flex;"><span>                deleted <span style="color:#f92672">=</span> queryset<span style="color:#f92672">.</span>delete(synchronize_session<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;fetch&#39;</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> deleted
</span></span><span style="display:flex;"><span>        session<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">crud_operation</span>(model_class: Type[ModelT], operation: Operation, data: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, identifier: int <span style="color:#f92672">|</span> str <span style="color:#f92672">|</span> UUID <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, skip: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, limit: int <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, filter_by: Dict <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>) <span style="color:#f92672">-&gt;</span> Any:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> operation <span style="color:#f92672">in</span> [<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">&#39;create&#39;</span>, Operation<span style="color:#f92672">.</span>CREATE]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model_create(model<span style="color:#f92672">=</span>model_class, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> operation <span style="color:#f92672">in</span> [<span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#39;read&#39;</span>, Operation<span style="color:#f92672">.</span>READ]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model_retrieve(model_class<span style="color:#f92672">=</span>model_class, identifier<span style="color:#f92672">=</span>identifier, skip<span style="color:#f92672">=</span>skip, limit<span style="color:#f92672">=</span>limit,
</span></span><span style="display:flex;"><span>                              filter_by<span style="color:#f92672">=</span>filter_by)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> operation <span style="color:#f92672">in</span> [<span style="color:#ae81ff">5</span>, <span style="color:#e6db74">&#39;update&#39;</span>, Operation<span style="color:#f92672">.</span>UPDATE]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model_update(model_class<span style="color:#f92672">=</span>model_class, identifier<span style="color:#f92672">=</span>identifier, data<span style="color:#f92672">=</span>data, filter_by<span style="color:#f92672">=</span>filter_by)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> operation <span style="color:#f92672">in</span> [<span style="color:#ae81ff">7</span>, <span style="color:#e6db74">&#39;delete&#39;</span>, Operation<span style="color:#f92672">.</span>DELETE]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model_destroy(model_class<span style="color:#f92672">=</span>model_class, identifier<span style="color:#f92672">=</span>identifier, filter_by<span style="color:#f92672">=</span>filter_by)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> operation <span style="color:#f92672">in</span> [<span style="color:#ae81ff">11</span>, <span style="color:#e6db74">&#39;list&#39;</span>, Operation<span style="color:#f92672">.</span>LIST]:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model_list(model_class, skip<span style="color:#f92672">=</span>skip, limit<span style="color:#f92672">=</span>limit, filter_by<span style="color:#f92672">=</span>filter_by)
</span></span></code></pre></div><p>We define the <code>model_create</code>, <code>model_retrieve</code>, <code>model_update</code>, <code>model_destroy</code>, and <code>crud_operation</code> function. The <code>crud_operation</code> function relies on the <code>model_create</code> to save new records of the specified model using the values passed as data parameter. The <code>model_retrieve</code> function retrieves any arbitrary record using a specified identifier which can be a unique attribute of the model, for example, slug field, primary key, or a uuid field. Where the <code>identifier</code> is not provided, a set of attributes (keys) with their corresponding values can be used. These key-value pairs should be passed in as a dictionary through the <code>filter_by</code> parameter. The <code>model_update</code> function modifies existing records of the model specified using the provided data. This function is a bulk operation by default as more than one result may be matching the resulting query and hence multiple updates can be done at once. In a scenario where only, a unique identifier is used, then a single record is expected to be modified or updated. Similar to the <code>model_retrieve</code>, the <code>filter_by</code> parameter can be used to specify attributes by which filtering can be performed. Each attribute should be passed as a dictionary key with their corresponding values. The <code>model_destroy</code> function is performs SQL queries like the <code>model_update</code> but it deletes matching records unlike the <code>model_update</code> that modifies matching records. Both the <code>model_update</code> and <code>model_destroy</code> returns a tuple of records affected and the count of values updated or deleted. Both <code>model_update</code> and <code>model_destroy</code> should be used cautiously as affected records will be modified or deleted once the Session object <code>commit()</code> function is called or the context manager terminates ‚Äì depending on the Session configuration like <code>autocommit</code> being set to <code>True</code>.</p>
<p>The <code>filter_by</code> parameter is used in the query expression to perform an equality check by default. This is a current limitation of the defined <code>crud_operation</code> function. A more powerful definition can make provision for specify conditional checks like using the OR, IN, NOT, LIKE and other SQL functions. Where such is desirable, defining a function that captures the specific business case can be used. However, in many situations, it is sufficient to retrieve or modify data using exact values, datatypes, and field names as portrayed in the <code>crud_operation</code>.</p>
<p>The <code>skip</code> and <code>limit</code> parameters of <code>model_retrieve</code>, <code>model_update</code> and <code>model_destroy</code> are used to specify the start and end indexes of the returned query results where more than one record matches the query criteria.</p>
<p>In the design of the <code>crud_operation</code>, we have used a set of flags to indicate what operation to perform. We also have used a context manager derived from a Session object in each of the composed functions of <code>crud_operation</code> (<code>model_create</code>, <code>mode_retrieve</code>, <code>model_destroy</code>, <code>model_update</code>). This is an alternative approach to using a <code>sessionmaker</code> as defined earlier. Another approach entails injecting a session parameter into a function using Dependency Injection. The FastAPI provides the <code>Depends</code> class towards that purpose. If using this approach, we simply pass a <code>session</code> into the desired code as a parameter with default value returned from <code>Depends</code> class. The <code>Depends</code> class can take a callable or other function construct that returns the desired data or object to pass as a parameter. This approach is common amongst FastAPI web applications, and it makes for easier to manage code as functions are loosely coupled.</p>
<p>With the <code>crud_operation</code> in place, we can focus on defining application centric queries for analysis and other business requirements. For example, we can define a query function to retrieve all transactions within a set period of start and end dates.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime <span style="color:#66d9ef">as</span> dt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> Depends
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> or_, insert
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> Session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> db <span style="color:#f92672">import</span> get_session
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> db.adapters <span style="color:#f92672">import</span> queryset_range
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> models <span style="color:#f92672">import</span> AppNotice, User, Organization
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> models.administration <span style="color:#f92672">import</span> notice_recipient_association
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_notice_for_a_user</span>(usid: str, start: dt<span style="color:#f92672">.</span>datetime, end: dt<span style="color:#f92672">.</span>datetime, skip, limit, s: Session <span style="color:#f92672">=</span> Depends(get_session)):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> s<span style="color:#f92672">.</span>begin():
</span></span><span style="display:flex;"><span>        user_query <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>id)<span style="color:#f92672">.</span>filter(or_(User<span style="color:#f92672">.</span>slug <span style="color:#f92672">==</span> usid, User<span style="color:#f92672">.</span>rsid <span style="color:#f92672">==</span> usid))<span style="color:#f92672">.</span>scalar_subquery()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> start <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> end:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>query(AppNotice)<span style="color:#f92672">.</span>join(User)<span style="color:#f92672">.</span>filter(AppNotice<span style="color:#f92672">.</span>start_at <span style="color:#f92672">&gt;=</span> start, User<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> user_query)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> end <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> start:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>query(AppNotice)<span style="color:#f92672">.</span>join(User)<span style="color:#f92672">.</span>filter(AppNotice<span style="color:#f92672">.</span>end_at <span style="color:#f92672">&lt;=</span> end, User<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> user_query)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            queryset <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>query(AppNotice)<span style="color:#f92672">.</span>join(User)<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>id <span style="color:#f92672">==</span> user_query)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> queryset_range(queryset, skip, limit)
</span></span></code></pre></div><p>We define a hypothetical <code>list_notice_for_a_user</code> function which retrieves a list of notices for the specified user. The session object is passed to the function as a parameter <code>s</code> using the <code>Depends</code> class. The <code>Depends</code> class takes a function <code>get_session</code> defined in our <code>db</code> package which returns an instance of <code>Session</code> class.</p>
<h3 id="threading-database-operations">Threading database operations</h3>
<p>In a web application, HTTP requests are sent to a server which may return a response after some operations. Certain times data may be read from a file, a database or third-party system. If the operation is synchronous, no other operation will be performed till the current request has been handled. When a synchronous operation is ongoing, a client may simply wait as the system can only respond after executing the current task. This may not be desirable in many scenarios. Take an example where we are to retrieve all transaction of a blockchain on a given network. Having millions of transactions, means we may wait significant time before all transactions are loaded into server memory and then passed unto our client, the browser. We could paginate our responses so we lazy load data and set a few results per page instead of reading all million transactions at once. This could improve the user‚Äôs perceived sense of speed of the application. The skip and limit parameter introduced in our <code>crud_operation</code> can help us define a variable length of data to fetch per time. We can also set these parameters to <code>None</code> or <code>0</code> to retrieve all available results at once.</p>
<p>Despite this improvement, we are still waiting for our blockchain network or a database operation to execute and give responses before rendering results as pages. We can consider another scenario in which our database operation can run on a different process or thread? Will there be an improved service? Furthermore, Python language provides several mechanisms for iterating a sequence and mechanism for parallel operations or concurrency. Can these be applied to database operations for web frameworks? The FastAPI framework is an async framework so asynchronous functions or coroutines can be used with the FastAPI application instance. SQLAlchemy 2.0 also support AsyncEngine and async session object allowing for asynchronous query of database, that is, queries can run concurrently. Depending on application requirements, these options can be explored to improve the quality and performance of code. A word of warning should be given at this point. Async programming is complex and not suitable in every instance. Furthermore, certain operations simply cannot be executed asynchronously. We need to ensure that the right solution is being used for the right problem whether we are dealing with asynchronous framework or simply printing ‚ÄúHello World‚Äù to a terminal. We will use a combination of Python Coroutine, Future, and Generator to improve on our database services. This approach is being explored as it enables us to still use SQLAlchemy ORM Session and not switch to asynchronous Session which are not widely used across web applications at the time of writing.</p>
<p>To achieve our goal of delegating database operations to a separate thread, we will define a <code>delegate_task</code> function that will be responsible for managing our threaded operations within a context manager. Python provides a high-level means for concurrent operations using the <code>ThreadPoolExecutor</code> or <code>ProcessPoolExecutor</code> context manager of the concurrent.futures package. We will use the <code>ThreadPoolExecutor</code> to initialize our database sessions on a separate thread as this operation is IO bound and not CPU bound.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Generator
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delegate_task</span>(task: Callable, workers: int <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, use_max: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>, args: Sequence <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, <span style="color:#f92672">**</span>kwargs) <span style="color:#f92672">-&gt;</span> Generator:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> workers <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        workers <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> use_max:
</span></span><span style="display:flex;"><span>        workers <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>workers) <span style="color:#66d9ef">as</span> ex:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> args <span style="color:#f92672">and</span> kwargs:
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> ex<span style="color:#f92672">.</span>submit(task, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> args <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> kwargs:
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> ex<span style="color:#f92672">.</span>submit(task, <span style="color:#f92672">*</span>args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> kwargs <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> args:
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> ex<span style="color:#f92672">.</span>submit(task, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> ex<span style="color:#f92672">.</span>submit(task)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> future<span style="color:#f92672">.</span>result()
</span></span></code></pre></div><p>The defined <code>delegate_task</code> function takes a callable named <code>task</code> and specifies parameters: <code>workers</code>, <code>use_max</code>, <code>args</code>, and <code>kwargs</code>. The <code>workers</code> parameter is an integer value indicating the number of threads to manage using the <code>ThreadPoolExecutor</code>, <code>use_max</code> boolean parameter specifies if the default maximum number of threads defined for the application should be used instead. The <code>args</code> and <code>kwargs</code> are passed to the callable <code>task</code> which is run within the <code>ThreadPoolExecutor</code> context manager via the <code>Executor</code> instance, <code>ex</code>. If the callable is ran successfully, a <code>future</code> object is returned via the ex.submit() function call. We can then wait for the outcome of the <code>future</code> object by calling its result method. Using this approach, we can set up a database session, establish connection with the database on a separate thread, and retrieve the database connection by calling <code>future.result()</code>. Notice the use of the <code>yield</code> reserved keyword to pass <code>future.result()</code> as a <code>Generator</code> object. This implies the output of calling <code>future.result()</code> is wrapped as a <code>Generator</code> object and then passed to the caller. Generators are good for iterating values and very efficient in memory usage. This way, we can generate database connection efficiently on separate threads and lazily retrieve query results when needed.  Let us also update our <code>get_session</code> function of <code>db</code> package to use concurrent programming.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> datetime <span style="color:#66d9ef">as</span> dt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> types
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> decimal <span style="color:#f92672">import</span> Decimal
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> enum <span style="color:#f92672">import</span> Enum
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, TypeVar, List, Tuple, Generator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.declarative <span style="color:#f92672">import</span> declarative_base
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> sessionmaker, Session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bitmast_mwallet.settings <span style="color:#f92672">import</span> DB_CONNECTION_URL
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> util <span style="color:#f92672">import</span> delegate_task
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(DB_CONNECTION_URL, echo<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ModelT <span style="color:#f92672">=</span> TypeVar(<span style="color:#e6db74">&#39;ModelT&#39;</span>, bound<span style="color:#f92672">=</span>Base)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_db</span>():
</span></span><span style="display:flex;"><span>    Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>create_all(bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">drop_db</span>():
</span></span><span style="display:flex;"><span>    Base<span style="color:#f92672">.</span>metadata<span style="color:#f92672">.</span>drop_all(engine)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_session</span>():
</span></span><span style="display:flex;"><span>    session <span style="color:#f92672">=</span> delegate_task(sessionmaker, workers<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, autocommit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, autoflush<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(session, Generator):
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> tuple(session)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result[<span style="color:#ae81ff">0</span>]()
</span></span></code></pre></div><p>We update the get_session function to return an instance of <code>Session</code>. However, this instance is retrieved from a <code>Generator</code> object returned by the <code>delegate_task</code> function. We validate that a <code>Generator</code> object is returned and then consume all values in the Generator instance by passing it to a tuple. We can then return the first object from our tuple which is expected to be a Session as that is the returned value from <code>sessionmarker</code>. With this in place all queries from our application can be run by passing our session object generated on a separate thread.</p>
<p>üîç</p>
<blockquote>
<p>An alternative approach of retrieving a session object from the output of <code>get_session</code> is to call the <code>next()</code> function with a <code>Generator</code> as its only parameter. This call is similar to retrieving the next value of a <code>Generator</code> by calling the <code>__next__</code> method of the object. If no more values are available in the Generator, a <code>StopIteration</code> error is raised.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Alteranate approach using Python next() builtin function </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>	gen_session <span style="color:#f92672">=</span> delegate_task(sessionmaker, workers<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, autocommit<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, autoflush<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>	session <span style="color:#f92672">=</span> next(gen_session)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">StopIteration</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><h3 id="database-transactions">Database transactions</h3>
<p>A database transaction may comprise multiple SQL operations that are treated as a single unit of work. A major characteristic of a database transaction is that it cannot leave the database in an inconsistent state. Database transactions have the following characteristic:</p>
<ol>
<li>Atomicity ‚Äì each SQL statement in a transaction must be completely executed or not executed at all. This requires that database queries are saved to persistent memory and does not leave the database in an inconsistent state. Where a query fails, the entire transaction will be rolled back to ensure a clearly defined state is maintained.</li>
<li>Consistent ‚Äì following the proper execution of queries, database must change from one known state to another. Each state change must be valid.</li>
<li>Isolation ‚Äì an unsaved or uncommitted SQL query should not affect execution of another query or concurrent transaction.</li>
<li>Durability ‚Äì a committed transaction must change the state of the database.
SQLAlchemy queries are executed as database transactions hence failed queries are rolled back by default. Users can also compose their queries using different constructs to obtain a desired SQL expression or result. Much flexibility in drafting SQL queries is achieved via the SQLAlchemy Core Query Expression language. Furthermore, query results can be managed using the sqlalchemy.engine.Result class and other datatypes like <code>CursorResult</code>, <code>MappedResult</code>, <code>Row</code>, <code>RowMapping</code> etc. More details on various result types can be seen in the <a href="https://docs.sqlalchemy.org/en/20/core/connections.html#result-set-api">SQLAlchemy documentation</a> .</li>
</ol>
<p>While the result from a query may be parsed as tuple, dictionary or even model instances, in some cases, it may be desirable to lazily consume query results. This will enable us to effectively use limited system resource. We will consider our previous example of retrieving all transactions from a given blockchain network. Earlier we had considered using pagination to improve on the response of our system. Now let‚Äôs adopt similar approach of using threads to manage query results as we did with initializing database sessions. Similar to the <code>delegate_task</code> function, we will define a decorator to serve as a wrapper for query functions that will yield a <code>Generator</code> which we can then iterate or consume at once.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> concurrent.futures <span style="color:#f92672">import</span> ThreadPoolExecutor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">thread_runner</span>(workers: int, use_max: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> workers <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        workers <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">or</span> settings<span style="color:#f92672">.</span>DEFAULT_THREAD_WORKERS
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> use_max:
</span></span><span style="display:flex;"><span>        workers <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorate</span>(func):
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@wraps</span>(func)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">with</span> ThreadPoolExecutor(max_workers<span style="color:#f92672">=</span>workers) <span style="color:#66d9ef">as</span> ex:
</span></span><span style="display:flex;"><span>                    future <span style="color:#f92672">=</span> ex<span style="color:#f92672">.</span>submit(func, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
</span></span><span style="display:flex;"><span>                    gen <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span>result()  <span style="color:#75715e"># the passed callable must return a Generator object</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> isinstance(gen, Generator):
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> tuple(gen)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">TypeError</span>(<span style="color:#e6db74">&#39;Expected type &lt;Generator&gt; but got </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> type(gen))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> wrapper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> decorate
</span></span></code></pre></div><p>We used the <code>ThreadPoolExecutor</code> to execute the query function define as <code>func</code> within a context manager. The <code>func</code> must return a <code>Generator</code> object else the decorator will raise a <code>TypeError</code>. We may consume all results from the <code>Generator</code> at once by passing it to the tuple class or we can return the <code>Generator</code> object for the other functions to iterate or consume. In our example, we simply consume <code>Generator</code> data and load this into memory. With our decorator in place, we can now modify the behaviour of our functions for running queries making them execute queries on a separate thread from the main thread running our application.</p>
<p>The use of separate thread for database queries is not a general recommendation for every possible business case. It was primarily highlighted here to show readers techniques in which long running processes in their web application can be improved using Python Generator and concurrency. Also, this approach was explored in the domain of cryptocurrency payment as a means of reducing latency in placing or satisfying trades. Assuming we have a high server hit rate for our remote database and blockchain API server, we will be able to send many more requests in a shorter time by using concurrency when compared to sending requests sequentially. The reader can still explore other alternatives in maximizing response, for example, the use of cache for retrieving already confirmed blockchain transactions.</p>
<h4 id="-further-reading---python-database-drivers">üìö Further Reading - Python database drivers</h4>
<blockquote>
<p>In this Chapter we have explored the use of SQLAlchemy to manage our database system. The SQLAlchemy is a good ORM for relational database and at the time of writing it does not support NoSQL databases like MongoDB. There are Python plugins for NoSQL databases with can be integrated into FastAPI applications. FastAPI approach of flexibility over convention allows developers to use existing Python tools to meet their business needs. Below are some plugins for managing some popular database systems which can be integrated into a FastAPI application.</p>
</blockquote>
<p>üìñ <a href="https://docs.datastax.com/en/developer/python-driver/3.24/">DataStax</a> for Cassandra database</p>
<p>üìñ Python <a href="https://www.mongodb.com/docs/drivers/pymongo/">MongoDB</a> driver for synchronous applications</p>
<p>üìñ Python <a href="https://www.mongodb.com/docs/drivers/motor/">MongoDB</a> driver for asynchronous applications</p>
<p>üìñ Python driver <a href="https://github.com/redis/redis-py">redis-py</a> for Redis database</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Vatlidation and database data flow in a sample FastAPI application&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Some defined attributes of the <code>BaseModel</code> of pydantic package&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>SQLAlchemy database connection to a sample Postgresql database system using Python driver <a href="https://pypi.org/project/psycopg2/"><code>postgresql</code></a>.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Figure of the SQLAlchemy engine architecture showing how the Engine references both a Dialect and a Pool object which provides DBAPI functions and database behaviour.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


    


                    
                    <div class="row"><div class="position-relative mx-auto col-lg-9">
                          
<div class="bg-primary overflow-hidden p-3 mt-5 shadow">

    <h4 class="text-white text-center">Read more</h4>

    <div class="d-flex justify-content-center"><a class="p-1 mr-3 d-inline-block text-white" href="/hugo_tutorial/chapter4/" title="Application services"><i class="fas fa-chevron-left p-1"></i>Application services</a>
        <a class="p-1 ml-3 d-inline-block text-white text-right" href="/hugo_tutorial/chapter6/" title="Middleware in FastAPI">Middleware in FastAPI<i class="fas fa-chevron-right p-1"></i></a>
    </div>
</div>


                        </div></div> 

                </div>

            </div> 

        </div> 
<script src="https://frier17.github.io/hugo_tutorial/lib/jquery.min.js"></script> 
<script src="https://frier17.github.io/hugo_tutorial/lib/popper.min.js"></script> 

<script src="https://frier17.github.io/hugo_tutorial/js/bootstrap.min.js"></script> 


<script type="text/javascript" src="/hugo_tutorial/plugins/lunr.min.js"></script>
<script type="text/javascript" src="/hugo_tutorial/plugins/auto-complete.js"></script>
<link href="/hugo_tutorial/plugins/auto-complete.css" rel="stylesheet">
<script type="text/javascript">
  
      var baseurl = "https:\/\/frier17.github.io\/hugo_tutorial\/";
  
</script>
<script type="text/javascript" src="/hugo_tutorial/plugins/search.js"></script>

<script type="text/javascript" src="/hugo_tutorial/plugins/favorites.js"></script>


<script type="text/javascript" src="/hugo_tutorial/plugins/clipboard.js"></script>
<script>
  new ClipboardJS('.btn');
</script>
</body>
</html>
