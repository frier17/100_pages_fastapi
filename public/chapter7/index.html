<!DOCTYPE html>
<html><head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <link rel="alternate" type="application/rss+xml" href="https://frier17.github.io/100_pages_fastapi/chapter7/index.xml" title="100 Pages to  FastAPI" />
    <link rel="canonical" href="https://frier17.github.io/100_pages_fastapi/chapter7/">

    <title>
        
        Authorization and Authentication | 100 Pages to  FastAPI
        
    </title>

    
    <link href="https://frier17.github.io/100_pages_fastapi/css/fontawesome.min.css" rel="stylesheet">

    
    <link rel="stylesheet" href="https://frier17.github.io/100_pages_fastapi/css/ace.min.css">

    

    
    
        
    

</head>
<body><nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow sticky-top" id="navbarMain">
    <div class="container">
        <div>
            
            <img src="https://frier17.github.io/100_pages_fastapi/img/nav_logo.png"/>
            
        </div>
        <div>
            <a class="navbar-brand" href="/100_pages_fastapi">
                100 Pages to  FastAPI
            </a>
        </div>
        
    </div>

</nav>
<div class="container-fluid">
            <div class="row">

                <div class="docs-sidenav order-0 col-12 col-md-3 col-lg-2 col-xl-2 position-sticky border-right"><nav class="navbar navbar-expand-md navbar-light pl-0">
    <button class="navbar-toggler navbar-toggler-right collapsed" type="button" data-toggle="collapse" data-target="#sidenav-left-collapse" aria-controls="sidenav-left-collapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

     <div class="collapse navbar-collapse align-items-start flex-column" id="sidenav-left-collapse">
            <form class="form-inline my-2 my-lg-0 searchbox">
                <input class="form-control mr-sm-2 w-100" data-search-input id="search-by" type="text" placeholder="Search">
            </form>

        

         <ul class="navbar-nav flex-column pt-3">
    <li data-nav-id="/100_pages_fastapi/preface/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/preface/"><h6>Preface</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/table_of_content/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/table_of_content/"><h6>Table of Content</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter1/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter1/"><h6>Introduction to FastAPI</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter2/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter2/"><h6>The mWallet Project</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter3/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter3/"><h6>Identifying Routes</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter4/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter4/"><h6>Application services</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter5/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter5/"><h6>The business domain entities and database layer</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter6/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter6/"><h6>Middleware in FastAPI</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter7/" class="nav-item my-1 active
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter7/"><h6>Authorization and Authentication</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter8/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter8/"><h6>Testing</h6></a>
        
    </li>
    <li data-nav-id="/100_pages_fastapi/chapter9/" class="nav-item my-1
        ">
        
        
          <a class="nav-link p-0" href="/100_pages_fastapi/chapter9/"><h6>Resources</h6></a>
        
    </li>
        </ul>
    </div>
</nav>


</div>
                <div class="docs-toc large order-lg-2 order-md-0 order-xs-1 col-12 col-lg-2 col-xl-2 position-sticky border-left"><div class="docs-toc">
	<nav id="TableOfContents">
  <ul>
    <li><a href="#authentication">Authentication</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#access-control">Access Control</a>
      <ul>
        <li><a href="#permission-based-on-scopes">Permission based on scopes</a></li>
      </ul>
    </li>
    <li><a href="#api-permission-class">API Permission class</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
</div>
</div>
                <div class="main col-12 order-1 col-md-9 col-lg-10 col-xl-8 py-3">
                

<div class="d-flex flex-column">
    <h1 class="js-title">Authorization and Authentication</h1>
    <div class="d-flex align-items-center">
        
    </div>
</div>

<hr>


<p>Authentication and access control are an important aspect of many applications. These layers of security should not be
ignored or treated as secondary but as a primary aspect of the system. In some cases, security and usability may require
further deliberation to maximize benefits for the user. Security guidelines by consortiums like Open Web Application
Security Project (OWASP) are helpful across various mobile and web applications. Other groups like Symposium on Usable
Privacy and Security (SOUPS) focuses on making usable security available for users. In this Chapter, we will explore
security in the FastAPI framework and design an approach of dynamically loading security settings for our mWallet
application.</p>
<p>üîç</p>
<blockquote>
<p>Some recommendations for improved security for online users adapted from research publish by SOUPS include:</p>
<ul>
<li>‚úÖ Install Software Updates</li>
<li>‚úÖ Use Unique Passwords</li>
<li>‚úÖ Use Two-Factor Authentication</li>
<li>‚úÖ Use Strong Passwords</li>
<li>‚úÖ Use a Password Manager</li>
<li>üìñ <a href="https://www.usenix.org/system/files/conference/soups2015/soups15-paper-ion.pdf">SOUPS Conference paper on security</a></li>
<li>üìñ <a href="https://arstechnica.com/information-technology/2015/07/what-amateurs-can-learn-from-security-pros-about-staying-safe-online/">Recommendation on security</a></li>
</ul>
</blockquote>
<p>OWASP discussed top ten security risks to consider for improving code security (<a href="https://owasp.org/www-project-top-ten/)">https://owasp.org/www-project-top-ten/)</a>.
These include:</p>
<ol>
<li>Broken Access Control</li>
<li>Cryptographic failures</li>
<li>Injection</li>
<li>Insecure design</li>
<li>Security misconfiguration</li>
<li>Vulnerable and outdated components</li>
<li>Identification and authentication failure</li>
<li>Software and data integrity failure</li>
<li>Security logging and monitoring failure</li>
<li>Server-side Request Forgery (SSRF)</li>
</ol>
<p>Authentication and Identification is a major security risk. Authentication are measures put in place to ensure that
users are who they said they are. This is different from Access Control or Authorization which determines what resource
or information a user can access or operate on. Privacy on the other hand is concerned with measures to control what
aspect of a user‚Äôs data is visible to third parties and the measures available to users to control access to their
personal data. In managing authentication, multiple security steps should be taken to reduce the possibility of an
attacker. Some guidelines following recommendations from OWASP and SOUPS are given below.</p>
<ul>
<li>Reduce the use of leaked or published usernames and password. For example, the application should not permit default,
weak, or well-known passwords, such as &ldquo;Password1&rdquo; or &ldquo;admin/admin&rdquo;.</li>
<li>Adopt measures to prevent or limit brute force or other automated attacks.</li>
<li>Password and credential recovery processes should not leak user personal information or assume only &ldquo;knowledge-based
answers&rdquo; (for example, name of pet) which cannot be made safe.</li>
<li>Where possible, use MFA along with username and password login. If only password is used, then encourage the use of
longer passwords of ten characters or more.</li>
<li>Do not expose session identifier in URL.</li>
<li>Expire or invalidate session, JWT token, or similar credentials after user logout or been idle for a period.</li>
</ul>
<p>A detailed security system cannot be effectively covered in a book like this. We will attempt a few security measures
and explain how these were implemented in the mWallet application using FastAPI. The following security features will be
adopted:</p>
<ul>
<li>A restricted username and password list will be used to prevent the use of leaked or published username and password
combination. This list is adopted from the github repository by Daniel
Miessler ( <a href="https://github.com/danielmiessler/SecLists">https://github.com/danielmiessler/SecLists</a>) and recommended by OWASP on implementing Digital
Identity (<a href="https://owasp.org/www-project-proactive-controls/v3/en/c6-digital-identity)">https://owasp.org/www-project-proactive-controls/v3/en/c6-digital-identity)</a>.</li>
<li>User group linked to named scope will be used to identify what API endpoint will be accessible to the various
categories of users. This approach was adopted to simplify access based on user group which may be linked to one or
more scopes. In effect, the scope property of our JWT will also match scope variables assigned to a given user group.
A detailed alternative may define a Scope model and map one or more scopes to any combination of user Group instances.</li>
<li>Financial transaction limits will used to limit the number of, and value of transactions performed by each tier of
users. Detail implementation of this is beyond the scope of this book.</li>
<li>User authentication will adopt username and password along with One Time Passcode (OTP). Each failed login leads to an
increasing wait time and ultimately blacklisting of IP address or username or both.</li>
</ul>
<p>With this in view let us explore authentication in FastAPI.</p>
<p>üîç</p>
<blockquote>
<p>Recommended security guidelines from OWASP were used to define the security policy of the mWallet application and the
security topics in this book. Further details can be found at the OWASP official website.</p>
<ul>
<li>üìñ <a href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/">Identification and authentication failures</a></li>
<li>üìñ <a href="https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/04-Authentication_Testing/README">Web application security testing</a></li>
<li>üìñ <a href="https://owasp.org/www-project-proactive-controls/v3/en/c6-digital-identity">Implement Digital Identity</a></li>
</ul>
</blockquote>
<h2 id="authentication">Authentication</h2>
<p>Authentication is an integral part of any web application. Various schemes are available, and some techniques are shared
across web frameworks. For example, Django framework has built in user Authentication unlike FastAPI that developers
implement authentication scheme of their choice, delegate authentication to external service, or rely on authorization
specifications like OAuth2 via the <code>fastapi.security package</code>. Furthermore, although the FastAPI is built on the
Starlette framework, the mechanism for authenticating and granting access to an endpoint in these frameworks is
different. While FastAPI uses dependency injection to inject authentication code in each path operation, Starlette
adopts an <code>AuthenticationMiddleware</code> by which all endpoints or selected endpoints can enforce authentication. The
FastAPI framework supports OAuth2 and uses this for authorising user‚Äôs access to a resource. OAuth2 is industry standard
authorisation for web API. A common setup is to have application servers delegate authentication service to a server
such as Google, Facebook to perform authentication of a user, and then grant limited access to a resource based on the
authentication outcome. In effect the application server delegates the service of identifying the user based on some
credentials to a trusted third party that implements the OAuth2 specification. The application server can also serve as
an authorisation and resource server while still providing access to third-party authentication using OAuth2
specifications. FastAPI provides a simplified and yet very effective means of authenticating users by
implementing <code>OAuth2</code> class that extends <code>SecurityBase</code> class. The <code>OAuth2</code> class enables developers specify what
endpoints requires authentication and authorise access based on an API token generated after duly validating a username
and password. This approach is managed via the <code>OAuth2PasswordBearer</code>. The <code>OAuth2PasswordBearer</code> extends the <code>OAuth2</code>
class and handles generating authorisation token using a username and password credentials.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_e30b2b45ba">
        Copy
        </button>
    </div>
    <div id="clipboard_e30b2b45ba">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi <span style="color:#fff;font-weight:bold">import</span> Depends, FastAPI
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.security <span style="color:#fff;font-weight:bold">import</span> OAuth2PasswordBearer
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> bitmast_mwallet <span style="color:#fff;font-weight:bold">import</span> settings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app = FastAPI()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>oauth2_scheme = OAuth2PasswordBearer(tokenUrl=settings.AUTH_TOKEN_URL)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@app.get(<span style="color:#0ff;font-weight:bold">&#34;/access/&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">async</span> <span style="color:#fff;font-weight:bold">def</span> user_access(token: <span style="color:#fff;font-weight:bold">str</span> = Depends(oauth2_scheme)):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">return</span> {<span style="color:#0ff;font-weight:bold">&#34;token&#34;</span>: token}
</span></span></code></pre></div>
    </div>
</div>




<p>By initializing an instance of the <code>OAuth2PasswordBearer</code> class, we can specify any endpoint needing users to have
authorized access through dependency injection. In our example, we defined a token URL assigned to <code>tokenUrl</code> parameter
by which users can obtain or refresh authorisation tokens. The path operation function will take a valid token as string
returned by calling <code>Depends(oauth2_scheme)</code> which injects the result of calling the instance
of <code>OAuthPasswordBearer</code>, <code>oauth2_scheme</code>. The <code>oauth2_scheme</code> as an instance of <code>OAuth2PasswordBearer</code> is also
callable. Calling this function will ensure a security scheme is attached to the endpoint and returns a string
representing a token that can be used with Authorization Bearer in the client‚Äôs request header. Where the application
also implements authentication, the username and password values posted to <code>user_access</code> endpoint can be checked against
a record (usually, retrieved from a database) to approve or reject access.</p>
<p>This scenario of using a username and password to obtain a token is defined in the OAuth2 specification as password
flow. It is sufficient for some businesses cases. There are other flows defined in the OAuth2 specification which
developers can adopt depending on their use case. FastAPI provides tools by which the basic OAuth2 password and other
flows can be integrated into an application. For our project, we will define an <code>AuthHandler</code> class that uses
the <code>HTTPBearer</code> class for authentication. With this class we receive login requests and generate a valid JWT token for
the user. We will also use the <code>AuthHandler</code> class to encrypt user password using a strong cryptographic hashing
algorithm. This is a recommended practise as passwords should not be saved as plain text.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_f688d0c721">
        Copy
        </button>
    </div>
    <div id="clipboard_f688d0c721">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> datetime <span style="color:#fff;font-weight:bold">import</span> timedelta
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> Any, Dict, List, Tuple, TypeVar, Generator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> stringcase
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi <span style="color:#fff;font-weight:bold">import</span> HTTPException, status, Body, Request, Security, Query, Depends
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.security <span style="color:#fff;font-weight:bold">import</span> HTTPBearer, HTTPAuthorizationCredentials, SecurityScopes
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> jose <span style="color:#fff;font-weight:bold">import</span> jwt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> passlib.context <span style="color:#fff;font-weight:bold">import</span> CryptContext
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> sqlalchemy <span style="color:#fff;font-weight:bold">import</span> create_engine, or_, insert
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> sqlalchemy.orm <span style="color:#fff;font-weight:bold">import</span> Session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> app_cryptography <span style="color:#fff;font-weight:bold">import</span> key_hashing, verify_key_hashing
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> bitmast_mwallet <span style="color:#fff;font-weight:bold">import</span> settings
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db <span style="color:#fff;font-weight:bold">import</span> get_session
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> messages <span style="color:#fff;font-weight:bold">import</span> error_messages
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> models.administration <span style="color:#fff;font-weight:bold">import</span> User, Group, user_group_association, UserType
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> schemas.administration <span style="color:#fff;font-weight:bold">import</span> LoginData
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> signals.authentication <span style="color:#fff;font-weight:bold">import</span> generate_otp_signal, sign_in_signal, sign_up_signal, password_reset_signal
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> signals.event_bus <span style="color:#fff;font-weight:bold">import</span> EventBus
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> util <span style="color:#fff;font-weight:bold">import</span> current_timezone, current_timestamp, thread_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine = create_engine(settings.DB_CONNECTION_URL, echo=<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger = logging.getLogger(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credentials_exception = HTTPException(
</span></span><span style="display:flex;"><span>    status_code=status.HTTP_401_UNAUTHORIZED,
</span></span><span style="display:flex;"><span>    detail=<span style="color:#0ff;font-weight:bold">&#34;Could not validate credentials&#34;</span>,
</span></span><span style="display:flex;"><span>    headers={<span style="color:#0ff;font-weight:bold">&#34;WWW-Authenticate&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Bearer&#34;</span>},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ALGORITHM = settings.AUTHENTICATION_ALGORITHM
</span></span><span style="display:flex;"><span>ACCESS_TOKEN_EXPIRE_MINUTES = settings.ACCESS_TOKEN_EXPIRE_MINUTES
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> AuthHandler:
</span></span><span style="display:flex;"><span>    security = HTTPBearer()
</span></span><span style="display:flex;"><span>    pwd_context = CryptContext(schemes=settings.PASSWORD_HASH_SCHEMES, deprecated=<span style="color:#0ff;font-weight:bold">&#39;auto&#39;</span>)
</span></span><span style="display:flex;"><span>    secret = settings.SECRET_KEY
</span></span><span style="display:flex;"><span>    scopes = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(self, scopes: List | Dict = <span style="color:#fff;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> scopes and <span style="color:#fff;font-weight:bold">isinstance</span>(scopes, List):
</span></span><span style="display:flex;"><span>            self.scopes = [x <span style="color:#fff;font-weight:bold">for</span> x in scopes <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(x, <span style="color:#fff;font-weight:bold">str</span>)]
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">elif</span> scopes and <span style="color:#fff;font-weight:bold">isinstance</span>(scopes, Dict):
</span></span><span style="display:flex;"><span>            self.scopes = [x <span style="color:#fff;font-weight:bold">for</span> x, _ in scopes.items()]
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            self.scopes = UserType.get_scopes()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> get_password_hash(self, password):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.pwd_context.hash(password)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> verify_password(self, plain_password, hashed_password):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.pwd_context.verify(plain_password, hashed_password)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> encode_token(self, user, scopes: List = <span style="color:#fff;font-weight:bold">None</span>, nonce: <span style="color:#fff;font-weight:bold">int</span> | <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#fff;font-weight:bold">None</span>) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
</span></span><span style="display:flex;"><span>        start = current_timezone()
</span></span><span style="display:flex;"><span>        end = start + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
</span></span><span style="display:flex;"><span>        payload = {
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#39;exp&#39;</span>: end,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#39;iat&#39;</span>: start,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#39;sub&#39;</span>: user,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(nonce, (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">float</span>, <span style="color:#fff;font-weight:bold">str</span>)):
</span></span><span style="display:flex;"><span>            nonce = <span style="color:#fff;font-weight:bold">str</span>(nonce)
</span></span><span style="display:flex;"><span>            payload.update(cnonce=nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> scopes:
</span></span><span style="display:flex;"><span>            s = get_session()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> s.begin():
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> s.query(Group.scope).join(User).filter(Group.scope.in_(scopes), User.slug == user).all():
</span></span><span style="display:flex;"><span>                    payload.update(scopes=scopes)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                    payload.update(scopes=[])
</span></span><span style="display:flex;"><span>                s.commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> jwt.encode(payload, self.secret, algorithm=settings.AUTHENTICATION_ALGORITHM)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> decode_token(self, token, flag: <span style="color:#fff;font-weight:bold">int</span> = <span style="color:#ff0;font-weight:bold">0</span>) -&gt; <span style="color:#fff;font-weight:bold">str</span> | Dict:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            payload = jwt.decode(token, self.secret, algorithms=[settings.AUTHENTICATION_ALGORITHM])
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> flag == <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> payload.get(<span style="color:#0ff;font-weight:bold">&#39;sub&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">elif</span> flag == <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> payload
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> jwt.ExpiredSignatureError:
</span></span><span style="display:flex;"><span>            credentials_exception.detail = <span style="color:#0ff;font-weight:bold">&#39;Signature has expired&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> credentials_exception
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> jwt.JWTError:
</span></span><span style="display:flex;"><span>            credentials_exception.headers.update({<span style="color:#0ff;font-weight:bold">&#39;WWW-Authenticate&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;Bearer&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> auth_wrapper(self, authentication_handler: HTTPAuthorizationCredentials = Security(security, scopes=scopes)):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.decode_token(authentication_handler.credentials)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> acl_wrapper(self, authentication_handler: HTTPAuthorizationCredentials = Security(security, scopes=scopes)):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self.decode_token(authentication_handler.credentials, flag=<span style="color:#ff0;font-weight:bold">1</span>)
</span></span></code></pre></div>
    </div>
</div>




<p>We defined an <code>AuthHandler</code> class to manage selected services relating to user authentication. As an example, we will
need to encrypt all user password before storing them to a database. The <code>AuthHandler</code> class will provide the needed
hashing method to secure our password records. A suitable hashing algorithm, preferably of a fixed length and slow
speed, should be selected. This will help reduce brute force and timing attacks. Python programming language supports
the BCRYPT algorithm, and this is use for password hashing due to its slow speed even on fast hardware. In our
implementation, we used the <code>passlib.context.CryptContext</code> class to initialize a context object from which we can
perform password hashing and password hash verification. The context object will internally select a matching algorithm
for hashing based on the configuration in our settings. <code>PASSWORD_HASH_SCHEMES</code> which returns a list of approved
algorithms for hashing. The <code>AuthHandler</code> <code>get_password_hash</code> method is used to generate hashes for a given password
using our declared context object as explained earlier. To authenticate a user, we will need to ensure that password
entered during login can be verified against an existing hash assigned to the user. We will use
the <code>AuthHandler</code> <code>verify_password</code> method to perform this operation. This method takes a plain password entered by a
user, and the target harsh recorded for that user at the point of registration. If the verification process is
successful, then a Boolean value of <code>True</code> is returned else <code>False</code>.</p>
<p>The <code>AuthHandler</code> class encode a dictionary of parameters to produce a single string. The <code>AuthHandler</code> <code>encode_token</code>
method performs this operation by using the <code>python-jose</code> package. This package can be installed with support for
cryptography using the pip command.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_9e1318b9c2">
        Copy
        </button>
    </div>
    <div id="clipboard_9e1318b9c2">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ pip install python-jose[cryptography]
</span></span></code></pre></div>
    </div>
</div>




<p>The OAuth2 specification recommends some keys to use for encoding but this is not mandatory. In our design we adopt
the <code>sub</code>, <code>iat</code>, and <code>exp</code> keys. These recommended keys should be used to encourage interoperability. We also
introduced the <code>cnonce</code> key which is a randomly generated number or string from the client. Where applicable,
the <code>cnonce</code> can be shared between the server and client to verify how fresh or recent a token is.</p>
<p>üîç</p>
<blockquote>
<p>The official specification of JWT defines a list of recommended keys which may not be mandatory. Developers can add
their own keys but should not use reserved names in the JWT definitions.
The following JWT keys are recommended but not mandatory.



<div class="table table-hover table-padded" role="alert">
    <blockquote>
<table>
<thead>
<tr>
<th>Key</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>iss</td>
<td>Issuer</td>
<td>The name of the service or application issuing the JWT</td>
</tr>
<tr>
<td>sub</td>
<td>Subject</td>
<td>The subject for which the JWT was generated. This is often the username where the password flow of OAuth2 is being used.</td>
</tr>
<tr>
<td>aud</td>
<td>Audience</td>
<td>The recipients of the JWT</td>
</tr>
<tr>
<td>exp</td>
<td>Expiration time</td>
<td>The time limit for the JWT. After this time, the JWT is invalid</td>
</tr>
<tr>
<td>iat</td>
<td>Issued at time</td>
<td>The time at which the generated JWT was issued</td>
</tr>
<tr>
<td>nbf</td>
<td>Not before</td>
<td>Indicates the time for which the JWT must not be accepted for processing</td>
</tr>
<tr>
<td>jti</td>
<td>JWT ID</td>
<td>A unique identifier for the JWT</td>
</tr>
</tbody>
</table>
</blockquote>


    <h4>Table 1</h4>
    <p>IANA required parameters for JWT defined tokens. A more detailed list of all possible keys can be found in the IANA <a href="https://www.iana.org/assignments/jwt/jwt.xhtml#claims">website</a></p>
</div>
</p>
</blockquote>
<p>Our <code>AuthHandler</code> class can decode JWT token for two primary use cases. The first use case is to provide an identifier
for a user upon successfully authenticating the user. This is performed by the <code>AuthHandler</code> <code>auth_wrapper</code> method. This
method when called will decode a given token string in the HTTP request Authorization Bearer header. If the operation is
successful, the target user is authenticated, and the unique identifier is returned. The second use case is like the
first as the HTTP request Authorization Bearer header is used to obtain the token. However, in the second use case, a
dictionary object of the credentials used for encoding the JWT token is returned. This case is used where more
information like the <code>scope</code> and <code>cnonce</code> are needed.</p>
<p>A scope is simply a string or list of names (may have URL encoded spaces) used in the JWT token to identify a collection
of permissions a user or client can have for the current token. For example, we can define a default scope,
named <code>default</code>, which allows unregistered users to only access the login, registration, signup, and welcome API
endpoints. All other endpoints will not be accessible to this user as they are outside the default user scope. OAuth2
specifies a scope can be provided in authentication form alongside the username and password using the password flow.</p>
<p>In our designed prototype, the authentication server is embedded in the same application server. In some other setup,
authentication may be done by a third-party, example Google. In this scenario, a client public ID (<code>client_id</code>) and a
client secret (<code>client_secret</code>) will be provided for the application. The client ID and secret are only available after
duly registering the application with the authentication service. Authenticating a user will then require sending needed
parameters like username or email to the specified authentication API endpoint. A sample of this is shown for using
Google and Facebook authentication service for a user. This operation entails getting a response that confirms the email
address of the user and if valid and the email is associated with a unique user in our application record, we can then
generate the needed access token for the user. However, if the email is verified by Google or Facebook but does not
exist in our application record, we can proceed to register the user with limited access by generating a token with the
default scope. This is shown in the <code>login_via_handle</code> function. By calling the <code>create_user</code> function using the
verified email we create a new user instance with a set of default permissions. We can select between the Google or
Facebook authentication service by a flag of integer value. The <code>get_user_by_identity</code> takes a verified email and
searches for a record of a user that is associated with this email. If a user is found, the function returns the
instance of the user, else it returns <code>None</code>.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_422568bf80">
        Copy
        </button>
    </div>
    <div id="clipboard_422568bf80">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> login_via_handle(data: Dict = Body(...), flag: <span style="color:#fff;font-weight:bold">int</span>) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
</span></span><span style="display:flex;"><span>    token = data.get(<span style="color:#0ff;font-weight:bold">&#39;accessToken&#39;</span>)
</span></span><span style="display:flex;"><span>    response = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> flag == <span style="color:#ff0;font-weight:bold">2</span>:
</span></span><span style="display:flex;"><span>        response = requests.get(settings.FACEBOOK_LOGIN_URL,
</span></span><span style="display:flex;"><span>                                params={<span style="color:#0ff;font-weight:bold">&#39;fields&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;id,name,email&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;access_token&#39;</span>: token}).json()
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">elif</span> flag == <span style="color:#ff0;font-weight:bold">3</span>:
</span></span><span style="display:flex;"><span>        response = requests.get(settings.GOOGLE_LOGIN_URL, params={<span style="color:#0ff;font-weight:bold">&#39;access_token&#39;</span>: token}).json()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> email := response.get(<span style="color:#0ff;font-weight:bold">&#39;email&#39;</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> user := get_user_by_identity(email):
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> {<span style="color:#0ff;font-weight:bold">&#39;access_token&#39;</span>: auth.encode_token(user.slug), <span style="color:#0ff;font-weight:bold">&#39;token_type&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;bearer&#39;</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            user = create_user({<span style="color:#0ff;font-weight:bold">&#39;email&#39;</span>: response.get(<span style="color:#0ff;font-weight:bold">&#39;email&#39;</span>)})
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> {<span style="color:#0ff;font-weight:bold">&#39;access_token&#39;</span>: auth.encode_token(user.slug), <span style="color:#0ff;font-weight:bold">&#39;token_type&#39;</span>: <span style="color:#0ff;font-weight:bold">&#39;bearer&#39;</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">raise</span> AppRequestException(status=status.HTTP_404_NOT_FOUND, errors=[error_messages.handle_signin],
</span></span><span style="display:flex;"><span>                                  success=<span style="color:#fff;font-weight:bold">False</span>)
</span></span></code></pre></div>
    </div>
</div>




<p>If no valid response is received from the authentication service, then we can raise an <code>ApplicationRequestException</code>
with a corresponding message stating the user cannot be registered or authenticated using the provided email or social
handle.</p>
<h4 id="-further-read---authentication">üìö Further Read - Authentication</h4>
<blockquote>
<p>Several methods exist for authenticating a user. For example, the OpenID connect builds on the OAuth2 specification and
can also be implemented in FastAPI. FastAPI framework provides the security package that enables developers adopt
different implementations on authenticating and managing access to resources. Further information on OAuth, OpenID, JWT
are listed below.</p>
<ul>
<li>üìñ <a href="https://datatracker.ietf.org/doc/html/rfc6749">OAuth2 Specification</a></li>
<li>üìñ <a href="https://openid.net/developers/how-connect-works/">How OpenID Connect works</a></li>
<li>üìñ <a href="https://datatracker.ietf.org/doc/html/rfc7519">RFC 7519 JSON Web Token</a></li>
</ul>
</blockquote>
<h2 id="access-control">Access Control</h2>
<p>Authentication and Access Control as shown in OWASP are major security factors to consider in any online or standalone
system. Web applications like the mWallet has a greater need for security considering the level of risks involved in
managing financial data of multiple users that may be across a wide region. The FastAPI provides tools for developers to
implement access control by using standard OAuth2PasswordBearer and similar security classes and to integrate third
party plugins. Developers can also design security classes of their own to suit their business needs. In our work so
far, we have implemented authentication as part of our application and shown how to authenticate users via Google and
Facebook service. The OAuth2 specification defines access control based on a token (an encoded string which may have
information contained as key-value pair) and requesting of permission using scopes. We will explore a simplified use of
scopes in JWT to define access for a user.</p>
<h3 id="permission-based-on-scopes">Permission based on scopes</h3>
<p>In the <code>AuthHandler</code> encoding operation, a set of parameters are encoded into the JWT. One of these parameters is the
scope information. We had earlier started that a scope is simply a list of strings that identifies what permission a
given token is assigned. Let us take a deeper look into the <code>encode_token</code> method. The <code>encode_token</code> method takes
a <code>user</code> parameter for uniquely identifying users; a <code>scopes</code> parameter which is a list of strings; an optional <code>cnonce</code>
parameter that can be an integer or string value. We define a <code>payload</code> dictionary which is a mapping of data to be
encoded into the JWT. The <code>payload</code> comprises the start and end time. These values are assigned to the <code>iat</code> and <code>exp</code>
keys of the JWT. We then can add the allowed permissions for the JWT using the provided scopes. The list is validated
against a database entry to ensure that the given user is in a <code>Group</code> that has a matching set of scopes and arbitrary
strings that are not defined as scopes will be rejected. This search is performed using our SQLAlchemy <code>session</code> object.
If our query is successful, then the set of provided scopes are added to the JWT otherwise, we add an empty list as our
scope key (that is, our default scope) in the JWT.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_89eba718c1">
        Copy
        </button>
    </div>
    <div id="clipboard_89eba718c1">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> logging
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> re
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> datetime <span style="color:#fff;font-weight:bold">import</span> timedelta
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> Any, Dict, List, Tuple, TypeVar, Generator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> stringcase
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi <span style="color:#fff;font-weight:bold">import</span> HTTPException, status, Body, Request, Security, Query, Depends
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.security <span style="color:#fff;font-weight:bold">import</span> HTTPBearer, HTTPAuthorizationCredentials, SecurityScopes
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> jose <span style="color:#fff;font-weight:bold">import</span> jwt
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> passlib.context <span style="color:#fff;font-weight:bold">import</span> CryptContext
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> sqlalchemy <span style="color:#fff;font-weight:bold">import</span> create_engine, or_, insert
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> sqlalchemy.orm <span style="color:#fff;font-weight:bold">import</span> Session
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> app_cryptography <span style="color:#fff;font-weight:bold">import</span> key_hashing, verify_key_hashing
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> bitmast_mwallet <span style="color:#fff;font-weight:bold">import</span> settings
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db <span style="color:#fff;font-weight:bold">import</span> get_session
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> messages <span style="color:#fff;font-weight:bold">import</span> error_messages
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> models.administration <span style="color:#fff;font-weight:bold">import</span> User, Group, user_group_association, UserType
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> schemas.administration <span style="color:#fff;font-weight:bold">import</span> LoginData
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> signals.authentication <span style="color:#fff;font-weight:bold">import</span> generate_otp_signal, sign_in_signal, sign_up_signal, password_reset_signal
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> signals.event_bus <span style="color:#fff;font-weight:bold">import</span> EventBus
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> util <span style="color:#fff;font-weight:bold">import</span> current_timezone, current_timestamp, thread_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine = create_engine(settings.DB_CONNECTION_URL, echo=<span style="color:#fff;font-weight:bold">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>logger = logging.getLogger(__name__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credentials_exception = HTTPException(
</span></span><span style="display:flex;"><span>    status_code=status.HTTP_401_UNAUTHORIZED,
</span></span><span style="display:flex;"><span>    detail=<span style="color:#0ff;font-weight:bold">&#34;Could not validate credentials&#34;</span>,
</span></span><span style="display:flex;"><span>    headers={<span style="color:#0ff;font-weight:bold">&#34;WWW-Authenticate&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Bearer&#34;</span>},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ALGORITHM = settings.AUTHENTICATION_ALGORITHM
</span></span><span style="display:flex;"><span>ACCESS_TOKEN_EXPIRE_MINUTES = settings.ACCESS_TOKEN_EXPIRE_MINUTES
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> AuthHandler:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># Excluded other class details</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> encode_token(self, user, scopes: List = <span style="color:#fff;font-weight:bold">None</span>, nonce: <span style="color:#fff;font-weight:bold">int</span> | <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#fff;font-weight:bold">None</span>) -&gt; <span style="color:#fff;font-weight:bold">str</span>:
</span></span><span style="display:flex;"><span>        start = current_timezone()
</span></span><span style="display:flex;"><span>        end = start + timedelta(minutes=settings.ACCESS_TOKEN_EXPIRE_MINUTES)
</span></span><span style="display:flex;"><span>        payload = {
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#39;exp&#39;</span>: end,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#39;iat&#39;</span>: start,
</span></span><span style="display:flex;"><span>            <span style="color:#0ff;font-weight:bold">&#39;sub&#39;</span>: user,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(nonce, (<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">float</span>, <span style="color:#fff;font-weight:bold">str</span>)):
</span></span><span style="display:flex;"><span>            nonce = <span style="color:#fff;font-weight:bold">str</span>(nonce)
</span></span><span style="display:flex;"><span>            payload.update(cnonce=nonce)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> scopes:
</span></span><span style="display:flex;"><span>            s = get_session()
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">with</span> s.begin():
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> s.query(Group.scope).join(User).filter(Group.scope.in_(scopes), User.slug == user).all():
</span></span><span style="display:flex;"><span>                    payload.update(scopes=scopes)
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>                    payload.update(scopes=[])
</span></span><span style="display:flex;"><span>                s.commit()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> jwt.encode(payload, self.secret, algorithm=settings.AUTHENTICATION_ALGORITHM)
</span></span></code></pre></div>
    </div>
</div>




<p>Our generated JWT now has information about scope. We may define a scope to support single or multiple permissions. For
example, Instagram web API allows clients to request a combination of scopes like <code>user_profile</code>, and <code>user_media</code> in a
single request which grants them access to multiple resources. Another approach could use a single scope string to allow
users access multiple resources. Example, a <code>user_resource</code> scope may allow a user to view a profile, media, and other
resources associated with a user. In the mWallet application, permission to users is granted by assigning the user to a
given Group. Each Group has a corresponding list of scopes that can be assigned to them. For instance, an admin user may
have access to add entry to a Catalogue of assets but not delete any asset from a Catalogue. A super admin user on the
other hand may add, edit, or delete entry to a Catalogue. Also, let&rsquo;s assume an admin user can add a new user but only
the registered user can update his or her profile. In effect, our permission system should be able to enable users
perform actions based on their Group and the type of Resource in view. To achieve our goal while keeping things simple,
we decided to define a permission.yml file and declaratively state what resource can be accessed by a given scope.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_f40e062d4e">
        Copy
        </button>
    </div>
    <div id="clipboard_f40e062d4e">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Define the various permission rules for defined user groups and types.</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Permissions are set on a per model basis using named scopes. This allows for different access rights to models for</span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># a given scope.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>permissions:
</span></span><span style="display:flex;"><span>  - model:
</span></span><span style="display:flex;"><span>      name: Catalogue
</span></span><span style="display:flex;"><span>      description: |
</span></span><span style="display:flex;"><span>        The catalogue permission describes a <span style="color:#fff;font-weight:bold">set</span> of permission <span style="color:#fff;font-weight:bold">for</span> the catalogue model. 
</span></span><span style="display:flex;"><span>        The permission will allow various users add, edit, view, or delete
</span></span><span style="display:flex;"><span>        a catalogue. Only user groups assigned permission can perform such task on a catalogue.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      permissions:
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: &amp;<span style="color:#fff;font-weight:bold">super</span> <span style="color:#fff;font-weight:bold">super</span> admin
</span></span><span style="display:flex;"><span>            action: &amp;super_permission [ delete, edit, view, add, <span style="color:#fff;font-weight:bold">list</span> ]
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: &amp;admin admin
</span></span><span style="display:flex;"><span>            action: *super_permission
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: &amp;auditor insurer officer
</span></span><span style="display:flex;"><span>            action: &amp;view_permission [ view ]
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: &amp;chief_auditor chief auditor
</span></span><span style="display:flex;"><span>            action: *view_permission
</span></span><span style="display:flex;"><span>  - model:
</span></span><span style="display:flex;"><span>      name: Services
</span></span><span style="display:flex;"><span>      description: |
</span></span><span style="display:flex;"><span>        Defines a <span style="color:#fff;font-weight:bold">range</span> of services which are available to various user types. 
</span></span><span style="display:flex;"><span>        This permission <span style="color:#fff;font-weight:bold">set</span> covers named API endpoints in the action attribute.
</span></span><span style="display:flex;"><span>      permissions:
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: *<span style="color:#fff;font-weight:bold">super</span>
</span></span><span style="display:flex;"><span>            action: &amp;super_admin_services
</span></span><span style="display:flex;"><span>              [
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># Define services for catalogue approval</span>
</span></span><span style="display:flex;"><span>                approve_catalogue_change_request,
</span></span><span style="display:flex;"><span>                revise_catalogue,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># Define services for catalogue resource</span>
</span></span><span style="display:flex;"><span>                basic_search,
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># Define services for order approval</span>
</span></span><span style="display:flex;"><span>                approve_order_auth_code,
</span></span><span style="display:flex;"><span>                approve_payment,
</span></span><span style="display:flex;"><span>                approve_payment_from_account,
</span></span><span style="display:flex;"><span>                generate_order_authentication_code,
</span></span><span style="display:flex;"><span>                view_open_orders,
</span></span><span style="display:flex;"><span>                view_open_transactions,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>              ]
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: *admin
</span></span><span style="display:flex;"><span>            action: *super_admin_services
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: *chief_auditor
</span></span><span style="display:flex;"><span>            action: [
</span></span><span style="display:flex;"><span>              <span style="color:#007f7f"># Define services for catalogue approval</span>
</span></span><span style="display:flex;"><span>              approve_catalogue_change_request,
</span></span><span style="display:flex;"><span>              revise_catalogue,
</span></span><span style="display:flex;"><span>              <span style="color:#007f7f"># Define services for catalogue resource</span>
</span></span><span style="display:flex;"><span>              basic_search,
</span></span><span style="display:flex;"><span>              <span style="color:#007f7f"># Define services for order approval</span>
</span></span><span style="display:flex;"><span>              approve_order_auth_code,
</span></span><span style="display:flex;"><span>              approve_payment,
</span></span><span style="display:flex;"><span>              approve_payment_from_account,
</span></span><span style="display:flex;"><span>              generate_order_authentication_code,
</span></span><span style="display:flex;"><span>              view_open_orders,
</span></span><span style="display:flex;"><span>              view_open_transactions,
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: *auditor
</span></span><span style="display:flex;"><span>            action: [
</span></span><span style="display:flex;"><span>              view_open_orders,
</span></span><span style="display:flex;"><span>              view_open_transactions,
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        - scope:
</span></span><span style="display:flex;"><span>            name: base user
</span></span><span style="display:flex;"><span>            action: [ register, home ]
</span></span></code></pre></div>
    </div>
</div>




<p>In our permission file, a <code>scope</code> is a mapping having a <code>name</code> and <code>action</code> key. The <code>name</code> key is a string that
identifies the scope with a human-readable name. The <code>action</code> key is a list of possible actions a user can perform if
given the scope in view. In effect, we declared a scope in the permission.yml file as having a list of actions. The
permission list in our <code>permission.yml</code> file holds all possible scope definitions for a given model. The model‚Äôs name
and description are captured by the corresponding model keys name and description.</p>
<p>Aside defining models and the scope associated with them, we can define API endpoints which may not be linked to any
given model. These API endpoints are tagged <code>Services</code> in our <code>permission.yml</code> file. A Service object can have a list of
permissions and corresponding scope definitions just like our model mapping. However, instead of having a list of CRUD
operations (<code>add</code>, <code>edit</code>, <code>view</code>, <code>delete</code>), the function name for the path operations is provided in the action
attribute. This approach enables us to define what API endpoint (that may or may not be associated with a given
Resource) a given user group can access.</p>
<p>We now have in place a permission file that informs us of the various actions a given user Group may perform. However,
we will also need to parse the <code>permission.yml</code> file into data that can be used by our application dynamically.
A <code>Permission</code> class is defined to consume the <code>permission.yml</code> file and generate a registry of scopes that defines
actions the user can perform. By centralizing our scopes and dynamically loading them at run time, we can manage user
access with minimal changes to our code and reduced read/write to our database. We could also save this information in a
database however, since our permission settings are not likely to be changed frequently and should not be changed during
an active user session, the file approach is more in line with our use case. In effect, once our FastAPI application is
started and all permission settings loaded, user permission or access can be managed programmatically without a possible
disruption if the database is being updated or temporarily unavailable. This could be very helpful for endpoints that
that does not query the database.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_762170bb30">
        Copy
        </button>
    </div>
    <div id="clipboard_762170bb30">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> TypeVar, Any, List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> stringcase
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db <span style="color:#fff;font-weight:bold">import</span> Base
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> models <span style="color:#fff;font-weight:bold">import</span> UserType
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> util <span style="color:#fff;font-weight:bold">import</span> extract_data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ModelType = TypeVar(<span style="color:#0ff;font-weight:bold">&#39;ModelType&#39;</span>, bound=Base)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>base = os.getcwd()
</span></span><span style="display:flex;"><span>permissions = os.path.join(base, <span style="color:#0ff;font-weight:bold">&#39;permissions&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;permissions.yml&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>messages = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>error_messages = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> Permission:
</span></span><span style="display:flex;"><span>    __slots__ = <span style="color:#0ff;font-weight:bold">&#39;_permissions&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_scopes&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_registry&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_meta&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># key in registry is model name or id</span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># key points to tuple or dict</span>
</span></span><span style="display:flex;"><span>        self._scopes = [stringcase.lowercase(x.name) <span style="color:#fff;font-weight:bold">for</span> x in UserType]
</span></span><span style="display:flex;"><span>        self._meta = {}
</span></span><span style="display:flex;"><span>        self._registry = {}
</span></span><span style="display:flex;"><span>        self._permissions = <span style="color:#fff;font-weight:bold">set</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">with</span> <span style="color:#fff;font-weight:bold">open</span>(permissions, <span style="color:#0ff;font-weight:bold">&#39;r&#39;</span>) <span style="color:#fff;font-weight:bold">as</span> fh:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>                data = yaml.safe_load(fh)
</span></span><span style="display:flex;"><span>                actions = []
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">for</span> user_permission in data.get(<span style="color:#0ff;font-weight:bold">&#39;permissions&#39;</span>):
</span></span><span style="display:flex;"><span>                    model_ = user_permission.get(<span style="color:#0ff;font-weight:bold">&#39;model&#39;</span>)
</span></span><span style="display:flex;"><span>                    model_name = model_.get(<span style="color:#0ff;font-weight:bold">&#39;name&#39;</span>)
</span></span><span style="display:flex;"><span>                    model_permission_description = model_.get(<span style="color:#0ff;font-weight:bold">&#39;description&#39;</span>)
</span></span><span style="display:flex;"><span>                    model_permissions = model_.get(<span style="color:#0ff;font-weight:bold">&#39;permissions&#39;</span>)
</span></span><span style="display:flex;"><span>                    record = []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">for</span> permission in model_permissions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        permission_action = extract_data(<span style="color:#0ff;font-weight:bold">&#39;action&#39;</span>, permission)
</span></span><span style="display:flex;"><span>                        permission_scope = extract_data(<span style="color:#0ff;font-weight:bold">&#39;name&#39;</span>, permission)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        scope = stringcase.snakecase(stringcase.lowercase(permission_scope))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        record.append((scope, permission_action,))
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span> permission_action:
</span></span><span style="display:flex;"><span>                            actions += permission_action
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    self._meta.update({model_name: model_permission_description})
</span></span><span style="display:flex;"><span>                    self._registry.update({model_name: record})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> actions:
</span></span><span style="display:flex;"><span>                    permission_set = <span style="color:#fff;font-weight:bold">set</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">for</span> a in actions:
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(a, <span style="color:#fff;font-weight:bold">str</span>):
</span></span><span style="display:flex;"><span>                            acts = a.split(<span style="color:#0ff;font-weight:bold">&#39; &#39;</span>, -<span style="color:#ff0;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>                            permission_set.update(acts)
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">elif</span> <span style="color:#fff;font-weight:bold">isinstance</span>(a, <span style="color:#fff;font-weight:bold">list</span> | <span style="color:#fff;font-weight:bold">tuple</span>):
</span></span><span style="display:flex;"><span>                            permission_set.update(a)
</span></span><span style="display:flex;"><span>                    self._permissions = permission_set
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">except</span> yaml.YAMLError:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> list_permissions(self, model):
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f"># Extract given field from possibly nested data structure</span>
</span></span><span style="display:flex;"><span>        data_ = self._registry.copy()
</span></span><span style="display:flex;"><span>        model_ = model <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(model, <span style="color:#fff;font-weight:bold">str</span>) <span style="color:#fff;font-weight:bold">else</span> model.__name__ <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(model, Base) <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        permission = data_.get(model_)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> permission
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> has_permission(self, model: Any, endpoint: <span style="color:#fff;font-weight:bold">str</span>) -&gt; <span style="color:#fff;font-weight:bold">bool</span>:
</span></span><span style="display:flex;"><span>        permission = self.list_permissions(model)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">any</span>([x <span style="color:#fff;font-weight:bold">for</span> x, y in permission <span style="color:#fff;font-weight:bold">if</span> endpoint == x or endpoint in y])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> get_permission(self, model: Any, endpoint: <span style="color:#fff;font-weight:bold">str</span>) -&gt; List:
</span></span><span style="display:flex;"><span>        permission = self.list_permissions(model)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> permission:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> [x <span style="color:#fff;font-weight:bold">for</span> x, y in permission <span style="color:#fff;font-weight:bold">if</span> y and endpoint in y]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> crud_permissions(self, model: Any) -&gt; List:
</span></span><span style="display:flex;"><span>        crud = [<span style="color:#0ff;font-weight:bold">&#39;delete&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;edit&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;view&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;add&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;list&#39;</span>]
</span></span><span style="display:flex;"><span>        permission = self.list_permissions(model)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> permission:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> [x <span style="color:#fff;font-weight:bold">for</span> x, y in permission <span style="color:#fff;font-weight:bold">if</span> y and <span style="color:#fff;font-weight:bold">set</span>(crud) &amp; <span style="color:#fff;font-weight:bold">set</span>(y)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @property
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> permissions(self):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self._permissions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @property
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> meta(self):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self._meta
</span></span></code></pre></div>
    </div>
</div>




<p>The <code>Permission</code> class is initialized without any parameter. Internally, the <code>__init__</code> method of this class will load
the data read from the <code>permission.yml</code> file and setup a registry of permissions using the <code>_registry</code> attribute.
The <code>_meta</code>, <code>_permissions</code> and <code>_scopes</code> attribute are all initialized to a default value with the <code>_scopes</code> being
assigned a list of values extracted from the <code>UserType</code> enum. If the <code>_registry</code> is successfully setup, the class
methods <code>list_permissions</code>, <code>has_permission</code>, <code>crud_permissions</code> can then be used to:</p>
<ul>
<li>List all permissions assigned to a given user group that can be encoded in the scope attribute of our JWT</li>
<li>Validate what permission or action can be performed on a resource</li>
<li>Validate if CRUD operations are supported by a given model.</li>
</ul>
<p>The <code>crud_permissions</code> indicates that various user groups can perform an arbitrary set of operation on a resource. For
instance, a user group may add a new record to a resource table but cannot delete any record from the resource table.
This fine-grained management of resources is suitable where certain resource should not be modified as changes may
affect services of other users in the same or different group.</p>
<p>One use case of the <code>Permission</code> class is to dynamically determine what scope or set of scopes should be available at
each API endpoint when registering routes. From our <code>permission.yml</code> file, we can see that the super admin user group
can approve request to change a catalogue, revise a change to a catalogue, perform basic search of catalogues, and other
services. The default user on the other hand can only access the registration endpoint and view the application home
endpoint. We can configure this information and load it into our route definitions, helping us define access control at
runtime. Furthermore, changes to our <code>permission.yml</code> file will be automatically reloaded into the application routes
upon system restart. This approach allows us to centralize management of permissions without affecting existing database
records.</p>
<h2 id="api-permission-class">API Permission class</h2>
<p><strong>Using dependencies to enforce permission</strong></p>
<p>Having the scopes needed per route is one part of the security equation. We also need to consider how to manage access
to models to perform CRUD operations that updates our underlying database. Web frameworks like Django, Laravel, or
CakePHP provides means by which CRUD operations can be performed from a model class. FastAPI does not come in built with
an ORM and as such developers can use an ORM of choice and access any utility available to them towards reaching their
use case. We will define a <code>ManageResource</code> class that will be used to perform any CRUD operation on a given SQLAlchemy
model class.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_657c447651">
        Copy
        </button>
    </div>
    <div id="clipboard_657c447651">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> enum <span style="color:#fff;font-weight:bold">import</span> Enum
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> Dict, Any, Optional, Type, List, Union, Sequence, Callable, Tuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi <span style="color:#fff;font-weight:bold">import</span> Body, Query, Path, params, HTTPException
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.datastructures <span style="color:#fff;font-weight:bold">import</span> DefaultPlaceholder, Default
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.encoders <span style="color:#fff;font-weight:bold">import</span> SetIntStr, DictIntStrAny
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.routing <span style="color:#fff;font-weight:bold">import</span> APIRoute
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.utils <span style="color:#fff;font-weight:bold">import</span> generate_unique_id
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> starlette <span style="color:#fff;font-weight:bold">import</span> status
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> starlette.responses <span style="color:#fff;font-weight:bold">import</span> Response, JSONResponse
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> starlette.routing <span style="color:#fff;font-weight:bold">import</span> BaseRoute
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> bhis_claims <span style="color:#fff;font-weight:bold">import</span> settings
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db.adapters <span style="color:#fff;font-weight:bold">import</span> crud_operation, Operation
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> util <span style="color:#fff;font-weight:bold">import</span> thread_runner
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credential_error = HTTPException(
</span></span><span style="display:flex;"><span>    status_code=status.HTTP_401_UNAUTHORIZED,
</span></span><span style="display:flex;"><span>    detail=<span style="color:#0ff;font-weight:bold">&#34;Unable to process resource for the selected user&#34;</span>,
</span></span><span style="display:flex;"><span>    headers={<span style="color:#0ff;font-weight:bold">&#34;WWW-Authenticate&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Bearer&#34;</span>},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> ManageResource:
</span></span><span style="display:flex;"><span>    __slots__ = (<span style="color:#0ff;font-weight:bold">&#39;_resource&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_router&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_schema&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> Config:
</span></span><span style="display:flex;"><span>        CREATE_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        LIST_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        UPDATE_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        DESTROY_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(self, resource, router, schema: Any = <span style="color:#fff;font-weight:bold">None</span>):
</span></span><span style="display:flex;"><span>        self._resource = resource
</span></span><span style="display:flex;"><span>        self._router = router
</span></span><span style="display:flex;"><span>        self._schema = schema
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        self.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        self.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        self.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>        self.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _create_resource(self, data: Any = Body(...)) -&gt; Any:
</span></span><span style="display:flex;"><span>        result = crud_operation(model_class=self._resource, data=data, operation=Operation.CREATE)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(result, <span style="color:#fff;font-weight:bold">tuple</span>) and <span style="color:#fff;font-weight:bold">len</span>(result) == <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> result[<span style="color:#ff0;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @thread_runner(workers=settings.DEFAULT_THREAD_WORKERS)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _retrieve_resource(self, identifier: Any = <span style="color:#fff;font-weight:bold">None</span>) -&gt; Any:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> crud_operation(model_class=self._resource, operation=Operation.READ, identifier=identifier)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _list_resource(self, skip: <span style="color:#fff;font-weight:bold">int</span> = Query(<span style="color:#fff;font-weight:bold">None</span>), limit: <span style="color:#fff;font-weight:bold">int</span> = Query(<span style="color:#fff;font-weight:bold">None</span>)) -&gt; List | Tuple:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> crud_operation(model_class=self._resource, operation=Operation.LIST, skip=skip, limit=limit)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _update_resource(self, identifier: Any = Path(<span style="color:#fff;font-weight:bold">None</span>), data: Dict = Body(...), criteria: Dict = Body(<span style="color:#fff;font-weight:bold">None</span>)) -&gt;
</span></span><span style="display:flex;"><span>            Tuple[Any, <span style="color:#fff;font-weight:bold">int</span>]:
</span></span><span style="display:flex;"><span>        result = crud_operation(model_class=self._resource, operation=Operation.UPDATE, identifier=identifier,
</span></span><span style="display:flex;"><span>                                data=data, filter_by=criteria)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(result, <span style="color:#fff;font-weight:bold">tuple</span>) and <span style="color:#fff;font-weight:bold">len</span>(result) == <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> result[<span style="color:#ff0;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _destroy_resource(self, identifier: Any = Path(<span style="color:#fff;font-weight:bold">None</span>)) -&gt; <span style="color:#fff;font-weight:bold">int</span>:
</span></span><span style="display:flex;"><span>        result = crud_operation(model_class=self._resource, operation=Operation.DELETE, identifier=identifier)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(result, <span style="color:#fff;font-weight:bold">tuple</span>) and <span style="color:#fff;font-weight:bold">len</span>(result) == <span style="color:#ff0;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> result[<span style="color:#ff0;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> create_route(self, path, *, response_model: Optional[Type[Any]] = <span style="color:#fff;font-weight:bold">None</span>, status_code: Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     tags: Optional[List[Union[<span style="color:#fff;font-weight:bold">str</span>, Enum]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     dependencies: Optional[Sequence[params.Depends]] = <span style="color:#fff;font-weight:bold">None</span>, summary: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     description: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>, response_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;Successful Response&#34;</span>,
</span></span><span style="display:flex;"><span>                     responses: Optional[Dict[Union[<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">str</span>], Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     deprecated: Optional[<span style="color:#fff;font-weight:bold">bool</span>] = <span style="color:#fff;font-weight:bold">None</span>, operation_id: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     response_model_include: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     response_model_exclude: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     response_model_by_alias: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>, response_model_exclude_unset: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                     response_model_exclude_defaults: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>, response_model_exclude_none: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                     include_in_schema: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>                     response_class: Union[Type[Response], DefaultPlaceholder] = Default(JSONResponse),
</span></span><span style="display:flex;"><span>                     name: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     callbacks: Optional[List[BaseRoute]] = <span style="color:#fff;font-weight:bold">None</span>, openapi_extra: Optional[Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     generate_unique_id_function: Union[Callable[[APIRoute], <span style="color:#fff;font-weight:bold">str</span>], DefaultPlaceholder] = Default(
</span></span><span style="display:flex;"><span>                         generate_unique_id)):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.Config.CREATE_FLAG:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not name:
</span></span><span style="display:flex;"><span>                name = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_add&#39;</span>
</span></span><span style="display:flex;"><span>            route = APIRoute(
</span></span><span style="display:flex;"><span>                path=path,
</span></span><span style="display:flex;"><span>                endpoint=self._create_resource,
</span></span><span style="display:flex;"><span>                methods=[<span style="color:#0ff;font-weight:bold">&#39;POST&#39;</span>],
</span></span><span style="display:flex;"><span>                name=name,
</span></span><span style="display:flex;"><span>                response_model=response_model,
</span></span><span style="display:flex;"><span>                status_code=status_code,
</span></span><span style="display:flex;"><span>                tags=tags,
</span></span><span style="display:flex;"><span>                dependencies=dependencies,
</span></span><span style="display:flex;"><span>                summary=summary,
</span></span><span style="display:flex;"><span>                description=description,
</span></span><span style="display:flex;"><span>                response_description=response_description,
</span></span><span style="display:flex;"><span>                responses=responses,
</span></span><span style="display:flex;"><span>                deprecated=deprecated,
</span></span><span style="display:flex;"><span>                operation_id=operation_id,
</span></span><span style="display:flex;"><span>                response_model_include=response_model_include,
</span></span><span style="display:flex;"><span>                response_model_exclude=response_model_exclude,
</span></span><span style="display:flex;"><span>                response_model_by_alias=response_model_by_alias,
</span></span><span style="display:flex;"><span>                response_model_exclude_unset=response_model_exclude_unset,
</span></span><span style="display:flex;"><span>                response_model_exclude_defaults=response_model_exclude_defaults,
</span></span><span style="display:flex;"><span>                response_model_exclude_none=response_model_exclude_none,
</span></span><span style="display:flex;"><span>                include_in_schema=include_in_schema,
</span></span><span style="display:flex;"><span>                response_class=response_class,
</span></span><span style="display:flex;"><span>                callbacks=callbacks,
</span></span><span style="display:flex;"><span>                openapi_extra=openapi_extra,
</span></span><span style="display:flex;"><span>                generate_unique_id_function=generate_unique_id_function
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            self._router.routes.append(route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> route
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> credential_error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> retrieve_route(self, path, *, response_model: Optional[Type[Any]] = <span style="color:#fff;font-weight:bold">None</span>, status_code: Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       tags: Optional[List[Union[<span style="color:#fff;font-weight:bold">str</span>, Enum]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       dependencies: Optional[Sequence[params.Depends]] = <span style="color:#fff;font-weight:bold">None</span>, summary: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       description: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>, response_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;Successful Response&#34;</span>,
</span></span><span style="display:flex;"><span>                       responses: Optional[Dict[Union[<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">str</span>], Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       deprecated: Optional[<span style="color:#fff;font-weight:bold">bool</span>] = <span style="color:#fff;font-weight:bold">None</span>, operation_id: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       response_model_include: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       response_model_exclude: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       response_model_by_alias: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>, response_model_exclude_unset: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                       response_model_exclude_defaults: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>, response_model_exclude_none: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                       include_in_schema: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>                       response_class: Union[Type[Response], DefaultPlaceholder] = Default(JSONResponse),
</span></span><span style="display:flex;"><span>                       name: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       callbacks: Optional[List[BaseRoute]] = <span style="color:#fff;font-weight:bold">None</span>, openapi_extra: Optional[Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                       generate_unique_id_function: Union[Callable[[APIRoute], <span style="color:#fff;font-weight:bold">str</span>], DefaultPlaceholder] = Default(
</span></span><span style="display:flex;"><span>                           generate_unique_id)):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.Config.RETRIEVE_FLAG:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not name:
</span></span><span style="display:flex;"><span>                name = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_view&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            route = APIRoute(
</span></span><span style="display:flex;"><span>                path=path,
</span></span><span style="display:flex;"><span>                endpoint=self._retrieve_resource,
</span></span><span style="display:flex;"><span>                methods=[<span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>],
</span></span><span style="display:flex;"><span>                name=name,
</span></span><span style="display:flex;"><span>                response_model=response_model,
</span></span><span style="display:flex;"><span>                status_code=status_code,
</span></span><span style="display:flex;"><span>                tags=tags,
</span></span><span style="display:flex;"><span>                dependencies=dependencies,
</span></span><span style="display:flex;"><span>                summary=summary,
</span></span><span style="display:flex;"><span>                description=description,
</span></span><span style="display:flex;"><span>                response_description=response_description,
</span></span><span style="display:flex;"><span>                responses=responses,
</span></span><span style="display:flex;"><span>                deprecated=deprecated,
</span></span><span style="display:flex;"><span>                operation_id=operation_id,
</span></span><span style="display:flex;"><span>                response_model_include=response_model_include,
</span></span><span style="display:flex;"><span>                response_model_exclude=response_model_exclude,
</span></span><span style="display:flex;"><span>                response_model_by_alias=response_model_by_alias,
</span></span><span style="display:flex;"><span>                response_model_exclude_unset=response_model_exclude_unset,
</span></span><span style="display:flex;"><span>                response_model_exclude_defaults=response_model_exclude_defaults,
</span></span><span style="display:flex;"><span>                response_model_exclude_none=response_model_exclude_none,
</span></span><span style="display:flex;"><span>                include_in_schema=include_in_schema,
</span></span><span style="display:flex;"><span>                response_class=response_class,
</span></span><span style="display:flex;"><span>                callbacks=callbacks,
</span></span><span style="display:flex;"><span>                openapi_extra=openapi_extra,
</span></span><span style="display:flex;"><span>                generate_unique_id_function=generate_unique_id_function
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            self._router.routes.append(route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> credential_error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> list_route(self, path, *, response_model: Optional[Type[Any]] = <span style="color:#fff;font-weight:bold">None</span>, status_code: Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   tags: Optional[List[Union[<span style="color:#fff;font-weight:bold">str</span>, Enum]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   dependencies: Optional[Sequence[params.Depends]] = <span style="color:#fff;font-weight:bold">None</span>, summary: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   description: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>, response_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;Successful Response&#34;</span>,
</span></span><span style="display:flex;"><span>                   responses: Optional[Dict[Union[<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">str</span>], Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   deprecated: Optional[<span style="color:#fff;font-weight:bold">bool</span>] = <span style="color:#fff;font-weight:bold">None</span>, operation_id: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   response_model_include: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   response_model_exclude: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   response_model_by_alias: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>, response_model_exclude_unset: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                   response_model_exclude_defaults: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>, response_model_exclude_none: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                   include_in_schema: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>                   response_class: Union[Type[Response], DefaultPlaceholder] = Default(JSONResponse),
</span></span><span style="display:flex;"><span>                   name: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   callbacks: Optional[List[BaseRoute]] = <span style="color:#fff;font-weight:bold">None</span>, openapi_extra: Optional[Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                   generate_unique_id_function: Union[Callable[[APIRoute], <span style="color:#fff;font-weight:bold">str</span>], DefaultPlaceholder] = Default(
</span></span><span style="display:flex;"><span>                       generate_unique_id)):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.Config.LIST_FLAG:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not name:
</span></span><span style="display:flex;"><span>                name = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_list&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            route = APIRoute(
</span></span><span style="display:flex;"><span>                path=path,
</span></span><span style="display:flex;"><span>                endpoint=self._list_resource,
</span></span><span style="display:flex;"><span>                methods=[<span style="color:#0ff;font-weight:bold">&#39;GET&#39;</span>],
</span></span><span style="display:flex;"><span>                name=name,
</span></span><span style="display:flex;"><span>                response_model=response_model,
</span></span><span style="display:flex;"><span>                status_code=status_code,
</span></span><span style="display:flex;"><span>                tags=tags,
</span></span><span style="display:flex;"><span>                dependencies=dependencies,
</span></span><span style="display:flex;"><span>                summary=summary,
</span></span><span style="display:flex;"><span>                description=description,
</span></span><span style="display:flex;"><span>                response_description=response_description,
</span></span><span style="display:flex;"><span>                responses=responses,
</span></span><span style="display:flex;"><span>                deprecated=deprecated,
</span></span><span style="display:flex;"><span>                operation_id=operation_id,
</span></span><span style="display:flex;"><span>                response_model_include=response_model_include,
</span></span><span style="display:flex;"><span>                response_model_exclude=response_model_exclude,
</span></span><span style="display:flex;"><span>                response_model_by_alias=response_model_by_alias,
</span></span><span style="display:flex;"><span>                response_model_exclude_unset=response_model_exclude_unset,
</span></span><span style="display:flex;"><span>                response_model_exclude_defaults=response_model_exclude_defaults,
</span></span><span style="display:flex;"><span>                response_model_exclude_none=response_model_exclude_none,
</span></span><span style="display:flex;"><span>                include_in_schema=include_in_schema,
</span></span><span style="display:flex;"><span>                response_class=response_class,
</span></span><span style="display:flex;"><span>                callbacks=callbacks,
</span></span><span style="display:flex;"><span>                openapi_extra=openapi_extra,
</span></span><span style="display:flex;"><span>                generate_unique_id_function=generate_unique_id_function
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            self._router.routes.append(route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> credential_error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> destroy_route(self, path, *, response_model: Optional[Type[Any]] = <span style="color:#fff;font-weight:bold">None</span>, status_code: Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      tags: Optional[List[Union[<span style="color:#fff;font-weight:bold">str</span>, Enum]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      dependencies: Optional[Sequence[params.Depends]] = <span style="color:#fff;font-weight:bold">None</span>, summary: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      description: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>, response_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;Successful Response&#34;</span>,
</span></span><span style="display:flex;"><span>                      responses: Optional[Dict[Union[<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">str</span>], Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      deprecated: Optional[<span style="color:#fff;font-weight:bold">bool</span>] = <span style="color:#fff;font-weight:bold">None</span>, operation_id: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      response_model_include: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      response_model_exclude: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      response_model_by_alias: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>, response_model_exclude_unset: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                      response_model_exclude_defaults: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>, response_model_exclude_none: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                      include_in_schema: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>                      response_class: Union[Type[Response], DefaultPlaceholder] = Default(JSONResponse),
</span></span><span style="display:flex;"><span>                      name: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      callbacks: Optional[List[BaseRoute]] = <span style="color:#fff;font-weight:bold">None</span>, openapi_extra: Optional[Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                      generate_unique_id_function: Union[Callable[[APIRoute], <span style="color:#fff;font-weight:bold">str</span>], DefaultPlaceholder] = Default(
</span></span><span style="display:flex;"><span>                          generate_unique_id)):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.Config.DESTROY_FLAG:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not name:
</span></span><span style="display:flex;"><span>                name = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_delete&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            route = APIRoute(
</span></span><span style="display:flex;"><span>                path=path,
</span></span><span style="display:flex;"><span>                endpoint=self._destroy_resource,
</span></span><span style="display:flex;"><span>                methods=[<span style="color:#0ff;font-weight:bold">&#39;DELETE&#39;</span>],
</span></span><span style="display:flex;"><span>                name=name,
</span></span><span style="display:flex;"><span>                response_model=response_model,
</span></span><span style="display:flex;"><span>                status_code=status_code,
</span></span><span style="display:flex;"><span>                tags=tags,
</span></span><span style="display:flex;"><span>                dependencies=dependencies,
</span></span><span style="display:flex;"><span>                summary=summary,
</span></span><span style="display:flex;"><span>                description=description,
</span></span><span style="display:flex;"><span>                response_description=response_description,
</span></span><span style="display:flex;"><span>                responses=responses,
</span></span><span style="display:flex;"><span>                deprecated=deprecated,
</span></span><span style="display:flex;"><span>                operation_id=operation_id,
</span></span><span style="display:flex;"><span>                response_model_include=response_model_include,
</span></span><span style="display:flex;"><span>                response_model_exclude=response_model_exclude,
</span></span><span style="display:flex;"><span>                response_model_by_alias=response_model_by_alias,
</span></span><span style="display:flex;"><span>                response_model_exclude_unset=response_model_exclude_unset,
</span></span><span style="display:flex;"><span>                response_model_exclude_defaults=response_model_exclude_defaults,
</span></span><span style="display:flex;"><span>                response_model_exclude_none=response_model_exclude_none,
</span></span><span style="display:flex;"><span>                include_in_schema=include_in_schema,
</span></span><span style="display:flex;"><span>                response_class=response_class,
</span></span><span style="display:flex;"><span>                callbacks=callbacks,
</span></span><span style="display:flex;"><span>                openapi_extra=openapi_extra,
</span></span><span style="display:flex;"><span>                generate_unique_id_function=generate_unique_id_function
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            self._router.routes.append(route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> credential_error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> update_route(self, path, *, response_model: Optional[Type[Any]] = <span style="color:#fff;font-weight:bold">None</span>, status_code: Optional[<span style="color:#fff;font-weight:bold">int</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     tags: Optional[List[Union[<span style="color:#fff;font-weight:bold">str</span>, Enum]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     dependencies: Optional[Sequence[params.Depends]] = <span style="color:#fff;font-weight:bold">None</span>, summary: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     description: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>, response_description: <span style="color:#fff;font-weight:bold">str</span> = <span style="color:#0ff;font-weight:bold">&#34;Successful Response&#34;</span>,
</span></span><span style="display:flex;"><span>                     responses: Optional[Dict[Union[<span style="color:#fff;font-weight:bold">int</span>, <span style="color:#fff;font-weight:bold">str</span>], Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     deprecated: Optional[<span style="color:#fff;font-weight:bold">bool</span>] = <span style="color:#fff;font-weight:bold">None</span>, operation_id: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     response_model_include: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     response_model_exclude: Optional[Union[SetIntStr, DictIntStrAny]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     response_model_by_alias: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>, response_model_exclude_unset: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                     response_model_exclude_defaults: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>, response_model_exclude_none: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">False</span>,
</span></span><span style="display:flex;"><span>                     include_in_schema: <span style="color:#fff;font-weight:bold">bool</span> = <span style="color:#fff;font-weight:bold">True</span>,
</span></span><span style="display:flex;"><span>                     response_class: Union[Type[Response], DefaultPlaceholder] = Default(JSONResponse),
</span></span><span style="display:flex;"><span>                     name: Optional[<span style="color:#fff;font-weight:bold">str</span>] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     callbacks: Optional[List[BaseRoute]] = <span style="color:#fff;font-weight:bold">None</span>, openapi_extra: Optional[Dict[<span style="color:#fff;font-weight:bold">str</span>, Any]] = <span style="color:#fff;font-weight:bold">None</span>,
</span></span><span style="display:flex;"><span>                     generate_unique_id_function: Union[Callable[[APIRoute], <span style="color:#fff;font-weight:bold">str</span>], DefaultPlaceholder] = Default(
</span></span><span style="display:flex;"><span>                         generate_unique_id)):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> self.Config.UPDATE_FLAG:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> not name:
</span></span><span style="display:flex;"><span>                name = <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_edit&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            route = APIRoute(
</span></span><span style="display:flex;"><span>                path=path,
</span></span><span style="display:flex;"><span>                endpoint=self._update_resource,
</span></span><span style="display:flex;"><span>                methods=[<span style="color:#0ff;font-weight:bold">&#39;PUT&#39;</span>],
</span></span><span style="display:flex;"><span>                name=name,
</span></span><span style="display:flex;"><span>                response_model=response_model,
</span></span><span style="display:flex;"><span>                status_code=status_code,
</span></span><span style="display:flex;"><span>                tags=tags,
</span></span><span style="display:flex;"><span>                dependencies=dependencies,
</span></span><span style="display:flex;"><span>                summary=summary,
</span></span><span style="display:flex;"><span>                description=description,
</span></span><span style="display:flex;"><span>                response_description=response_description,
</span></span><span style="display:flex;"><span>                responses=responses,
</span></span><span style="display:flex;"><span>                deprecated=deprecated,
</span></span><span style="display:flex;"><span>                operation_id=operation_id,
</span></span><span style="display:flex;"><span>                response_model_include=response_model_include,
</span></span><span style="display:flex;"><span>                response_model_exclude=response_model_exclude,
</span></span><span style="display:flex;"><span>                response_model_by_alias=response_model_by_alias,
</span></span><span style="display:flex;"><span>                response_model_exclude_unset=response_model_exclude_unset,
</span></span><span style="display:flex;"><span>                response_model_exclude_defaults=response_model_exclude_defaults,
</span></span><span style="display:flex;"><span>                response_model_exclude_none=response_model_exclude_none,
</span></span><span style="display:flex;"><span>                include_in_schema=include_in_schema,
</span></span><span style="display:flex;"><span>                response_class=response_class,
</span></span><span style="display:flex;"><span>                callbacks=callbacks,
</span></span><span style="display:flex;"><span>                openapi_extra=openapi_extra,
</span></span><span style="display:flex;"><span>                generate_unique_id_function=generate_unique_id_function
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            self._router.routes.append(route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> credential_error
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @property
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> router(self):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> self._router
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> CreateMixin(ManageResource):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> Config:
</span></span><span style="display:flex;"><span>        CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> RetrieveMixin(ManageResource):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> Config:
</span></span><span style="display:flex;"><span>        RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> UpdateMixin(ManageResource):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> Config:
</span></span><span style="display:flex;"><span>        UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> DestroyMixin(ManageResource):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> Config:
</span></span><span style="display:flex;"><span>        DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> ListMixin(ManageResource):
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">class</span> Config:
</span></span><span style="display:flex;"><span>        LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span></code></pre></div>
    </div>
</div>




<p>The <code>ManageResource</code> defines an inner <code>Config</code> class along with a set of attributes <code>_resource</code>, <code>_schema</code>,
and <code>_router</code>. The <code>Config</code> class is used to set flags for CRUD operations. The named
flags <code>CREATE_FLAG</code>, <code>RETRIEVE_FLAG</code>,       <code>LIST_FLAG</code>, <code>UPDATE_FLAG</code>, <code>DESTROY_FLAG</code> all have a default value
of <code>False</code>. The <code>_resource</code> attribute holds a reference to the given SQLAlchemy ORM model which a CRUD operation is
being performed on. The <code>_schema</code> attribute holds a reference to the pydantic model class that is associated with the
given resource or SQLAlchemy ORM model. This schema class may be dynamically generated as shown earlier using
the <code>make_schema</code> class. (See Defining and Generating schemas section in <a href="../chp5/chp5.md">Chapter 5</a> - The business
domain entities and database layer).</p>
<p>The <code>ManageResource</code> also defines a set of methods used as path operation functions, that is, functions or other
callables that will handle HTTP request sent to a given URL. The defined CRUD operation path will rely on these
functions for handling user\92s requests to create, read, update, or delete a resource. These
methods <code>_create_resource</code>, <code>_retrieve_resource</code>, <code>_update_resource</code>, <code>_destroy_resource</code>, and <code>_list_resource</code> is used
internally by the <code>ManageResource</code> class to define FastAPI <code>APIRoute</code> instances which can be added to our FastAPI
application through the <code>add_api_route</code> or <code>add_route</code> methods as needed. In our definition,
the <code>ManageResource._create_resource</code>, <code>ManageResource._retrieve_resource</code>, <code>ManageResource._update_resource</code>, <code>ManageResource._destroy_resource</code>,
and <code>ManageResource._list_resource</code> are the endpoint functions called by the respective routes to add, view, edit,
delete or list all instances of the specified model. This is achieved in
the <code>ManageResource.create_route</code>, <code>ManageResource.retrieve_route</code>, <code>ManageResource.update_route</code>, <code>ManageResource.destroy_route</code>,
and <code>ManageResource.list_route</code> which initializes the respective APIRoute instances. By using this approach, we can
simply call the <code>ManageReource</code> methods to return a route that will be added to the application. For example,
the <code>ManageResource.create_route</code> will return a FastAPI APIRoute instance which can be added to the FastAPI application.</p>
<p>Our <code>ManageResource</code> class can generate various routes to perform CRUD operations, however, we do not yet have fine
grained access control. At the current state, all CRUD operations are available to any group of users. So, what if we
want fine grained control of what CRUD operation can be performed on a resource? To achieve this, we can extend
the <code>ManageResource</code> and put measures in place that will enforce access based on a set of flags received.</p>
<p>We defined the <code>APIRouteResource</code> class to extend <code>ManageResource</code>. Operations for CRUD services will be managed by the
base class but the derived class, <code>APIRouteResource</code>, will manage what CRUD operation will be available and dynamically
add permissions defined in our <code>permission.yml</code> file through a <code>Permission</code> object. This will enable us to achieve a
mixins like behaviours where we can select what CRUD operations are available based on the specified resource. For
example, we can have scenarios where only read operations (retrieve or list resources) are available and all write
operations (update or delete resources) are not available. Furthermore, we can customise the behaviour of the given
method by using the <code>Permission</code> object to restrict access control based on <code>Group</code> assigned to the current user. We
will look at various segments of the <code>APIRouteResource</code> and the <code>PermissionResource</code> to see how this is achieved.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_7503a9bcc5">
        Copy
        </button>
    </div>
    <div id="clipboard_7503a9bcc5">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> enum <span style="color:#fff;font-weight:bold">import</span> IntFlag
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> TypeVar, Any, get_type_hints, Callable, TYPE_CHECKING, NoReturn, List, MutableSequence, Tuple
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi <span style="color:#fff;font-weight:bold">import</span> Security, HTTPException
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi.routing <span style="color:#fff;font-weight:bold">import</span> APIRoute
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi_restful.inferring_router <span style="color:#fff;font-weight:bold">import</span> InferringRouter
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> starlette <span style="color:#fff;font-weight:bold">import</span> status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> authentication.services.jwt_handler <span style="color:#fff;font-weight:bold">import</span> get_user_access
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db <span style="color:#fff;font-weight:bold">import</span> Base
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db.resource <span style="color:#fff;font-weight:bold">import</span> ManageResource
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> db.schemas <span style="color:#fff;font-weight:bold">import</span> make_schema
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> permissions <span style="color:#fff;font-weight:bold">import</span> Permission
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> routers <span style="color:#fff;font-weight:bold">import</span> app_routes
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> schemas.base <span style="color:#fff;font-weight:bold">import</span> DefaultResponse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ModelT = TypeVar(<span style="color:#0ff;font-weight:bold">&#39;ModelT&#39;</span>, bound=Base)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> ResourceFlags(IntFlag):
</span></span><span style="display:flex;"><span>    CREATE = <span style="color:#ff0;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    RETRIEVE = <span style="color:#ff0;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>    UPDATE = <span style="color:#ff0;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>    DESTROY = <span style="color:#ff0;font-weight:bold">7</span>
</span></span><span style="display:flex;"><span>    LIST = <span style="color:#ff0;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credential_error = HTTPException(
</span></span><span style="display:flex;"><span>    status_code=status.HTTP_401_UNAUTHORIZED,
</span></span><span style="display:flex;"><span>    detail=<span style="color:#0ff;font-weight:bold">&#34;Unable to process resource for the selected user&#34;</span>,
</span></span><span style="display:flex;"><span>    headers={<span style="color:#0ff;font-weight:bold">&#34;WWW-Authenticate&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Bearer&#34;</span>},
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> APIRouteResource(ManageResource):
</span></span><span style="display:flex;"><span>    app_permissions = Permission()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(self, resource, router, schema: Any = <span style="color:#fff;font-weight:bold">None</span>, flags: <span style="color:#fff;font-weight:bold">int</span> | ResourceFlags | List = <span style="color:#ff0;font-weight:bold">0</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>().__init__(resource, router, schema)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> flags:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.CREATE | <span style="color:#ff0;font-weight:bold">2</span>:
</span></span><span style="display:flex;"><span>                self.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.UPDATE | <span style="color:#ff0;font-weight:bold">5</span>:
</span></span><span style="display:flex;"><span>                self.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.DESTROY | <span style="color:#ff0;font-weight:bold">7</span>:
</span></span><span style="display:flex;"><span>                self.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.RETRIEVE | <span style="color:#ff0;font-weight:bold">3</span>:
</span></span><span style="display:flex;"><span>                self.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.LIST | <span style="color:#ff0;font-weight:bold">11</span>:
</span></span><span style="display:flex;"><span>                self.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> [ResourceFlags.RETRIEVE, ResourceFlags.LIST]:
</span></span><span style="display:flex;"><span>                self.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> [ResourceFlags.CREATE, ResourceFlags.UPDATE, ResourceFlags.DESTROY]:
</span></span><span style="display:flex;"><span>                self.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> [ResourceFlags.CREATE, ResourceFlags.RETRIEVE, ResourceFlags.UPDATE, ResourceFlags.DESTROY,
</span></span><span style="display:flex;"><span>                  ResourceFlags.LIST]:
</span></span><span style="display:flex;"><span>                self.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                self.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> _ <span style="color:#fff;font-weight:bold">as</span> fls:
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># evaluate any possible combination of flags.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f"># if flag name has create, then call create_route etc.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(fls, MutableSequence):
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.CREATE in fls:
</span></span><span style="display:flex;"><span>                        self.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.UPDATE in fls:
</span></span><span style="display:flex;"><span>                        self.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.LIST in fls:
</span></span><span style="display:flex;"><span>                        self.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.DESTROY in fls:
</span></span><span style="display:flex;"><span>                        self.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.RETRIEVE in fls:
</span></span><span style="display:flex;"><span>                        self.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @classmethod
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> api_readonly(cls, resource, router, schema, **kwargs):
</span></span><span style="display:flex;"><span>        instance = cls(resource, router, schema)
</span></span><span style="display:flex;"><span>        instance.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">all</span>((instance.list_route(**kwargs), instance.retrieve_route(**kwargs)))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> instance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @classmethod
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> api_write(cls, resource, router, schema, **kwargs):
</span></span><span style="display:flex;"><span>        instance = cls(resource, router, schema)
</span></span><span style="display:flex;"><span>        instance.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">all</span>((instance.create_route(**kwargs), instance.update_route(**kwargs), instance.destroy_route(**kwargs)))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> instance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @classmethod
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> api_read_write(cls, resource, router, schema, **kwargs):
</span></span><span style="display:flex;"><span>        instance = cls(resource, router, schema)
</span></span><span style="display:flex;"><span>        instance.Config.CREATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.RETRIEVE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.DESTROY_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.LIST_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        instance.Config.UPDATE_FLAG = <span style="color:#fff;font-weight:bold">True</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">all</span>((instance.create_route(**kwargs), instance.retrieve_route(**kwargs), instance.destroy_route(**kwargs),
</span></span><span style="display:flex;"><span>             instance.list_route(**kwargs), instance.update_route(**kwargs)))
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> instance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> _process_route(self, flag):
</span></span><span style="display:flex;"><span>        search = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        scopes = <span style="color:#fff;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> flag == ResourceFlags.CREATE:
</span></span><span style="display:flex;"><span>            scopes = self.app_permissions.get_permission(self._resource.__name__, endpoint=<span style="color:#0ff;font-weight:bold">&#39;add&#39;</span>)
</span></span><span style="display:flex;"><span>            search = (x <span style="color:#fff;font-weight:bold">for</span> x in app_routes.routes <span style="color:#fff;font-weight:bold">if</span> x.resource == self._resource.__name__ and x.crud_type == <span style="color:#0ff;font-weight:bold">&#39;add&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">elif</span> flag == ResourceFlags.LIST:
</span></span><span style="display:flex;"><span>            scopes = self.app_permissions.get_permission(self._resource.__name__, endpoint=<span style="color:#0ff;font-weight:bold">&#39;list&#39;</span>)
</span></span><span style="display:flex;"><span>            search = (x <span style="color:#fff;font-weight:bold">for</span> x in app_routes.routes <span style="color:#fff;font-weight:bold">if</span> x.resource == self._resource.__name__ and x.crud_type == <span style="color:#0ff;font-weight:bold">&#39;list&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">elif</span> flag == ResourceFlags.UPDATE:
</span></span><span style="display:flex;"><span>            scopes = self.app_permissions.get_permission(self._resource.__name__, endpoint=<span style="color:#0ff;font-weight:bold">&#39;edit&#39;</span>)
</span></span><span style="display:flex;"><span>            search = (x <span style="color:#fff;font-weight:bold">for</span> x in app_routes.routes <span style="color:#fff;font-weight:bold">if</span> x.resource == self._resource.__name__ and x.crud_type == <span style="color:#0ff;font-weight:bold">&#39;edit&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">elif</span> flag == ResourceFlags.DESTROY:
</span></span><span style="display:flex;"><span>            scopes = self.app_permissions.get_permission(self._resource.__name__, endpoint=<span style="color:#0ff;font-weight:bold">&#39;delete&#39;</span>)
</span></span><span style="display:flex;"><span>            search = (x <span style="color:#fff;font-weight:bold">for</span> x in app_routes.routes <span style="color:#fff;font-weight:bold">if</span> x.resource == self._resource.__name__ and x.crud_type == <span style="color:#0ff;font-weight:bold">&#39;delete&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">elif</span> flag == ResourceFlags.RETRIEVE:
</span></span><span style="display:flex;"><span>            scopes = self.app_permissions.get_permission(self._resource.__name__, endpoint=<span style="color:#0ff;font-weight:bold">&#39;view&#39;</span>)
</span></span><span style="display:flex;"><span>            search = (x <span style="color:#fff;font-weight:bold">for</span> x in app_routes.routes <span style="color:#fff;font-weight:bold">if</span> x.resource == self._resource.__name__ and x.crud_type == <span style="color:#0ff;font-weight:bold">&#39;view&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> scopes, search
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> create_route(self, **kwargs):
</span></span><span style="display:flex;"><span>        scopes, search = self._process_route(flag=ResourceFlags.CREATE)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># create route and add to router</span>
</span></span><span style="display:flex;"><span>            route = <span style="color:#fff;font-weight:bold">next</span>(search)
</span></span><span style="display:flex;"><span>            permission_create_route = APIRoute(
</span></span><span style="display:flex;"><span>                path=route.url_path,
</span></span><span style="display:flex;"><span>                methods=route.methods,
</span></span><span style="display:flex;"><span>                endpoint=self._create_resource,
</span></span><span style="display:flex;"><span>                tags=route.tags,
</span></span><span style="display:flex;"><span>                description=route.description,
</span></span><span style="display:flex;"><span>                name=route.name,
</span></span><span style="display:flex;"><span>                status_code=route.status,
</span></span><span style="display:flex;"><span>                response_model=make_schema(self._resource),
</span></span><span style="display:flex;"><span>                response_description=route.success,
</span></span><span style="display:flex;"><span>                dependencies=[Security(get_user_access, scopes=scopes)],
</span></span><span style="display:flex;"><span>                **kwargs
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># add to router</span>
</span></span><span style="display:flex;"><span>            self._router.routes.append(permission_create_route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> permission_create_route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> StopIteration:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> retrieve_route(self, **kwargs):
</span></span><span style="display:flex;"><span>        scopes, search = self._process_route(flag=ResourceFlags.RETRIEVE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            route = <span style="color:#fff;font-weight:bold">next</span>(search)
</span></span><span style="display:flex;"><span>            permission_retrieve_route = APIRoute(
</span></span><span style="display:flex;"><span>                path=route.url_path,
</span></span><span style="display:flex;"><span>                methods=route.methods,
</span></span><span style="display:flex;"><span>                endpoint=self._retrieve_resource,
</span></span><span style="display:flex;"><span>                tags=route.tags,
</span></span><span style="display:flex;"><span>                description=route.description,
</span></span><span style="display:flex;"><span>                name=route.name,
</span></span><span style="display:flex;"><span>                status_code=route.status,
</span></span><span style="display:flex;"><span>                response_model=make_schema(self._resource),
</span></span><span style="display:flex;"><span>                response_description=route.success,
</span></span><span style="display:flex;"><span>                dependencies=[Security(get_user_access, scopes=scopes)],
</span></span><span style="display:flex;"><span>                **kwargs
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># add to router</span>
</span></span><span style="display:flex;"><span>            self._router.routes.append(permission_retrieve_route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> permission_retrieve_route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> StopIteration:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> update_route(self, **kwargs):
</span></span><span style="display:flex;"><span>        scopes, search = self._process_route(flag=ResourceFlags.UPDATE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            route = <span style="color:#fff;font-weight:bold">next</span>(search)
</span></span><span style="display:flex;"><span>            permission_update_route = APIRoute(
</span></span><span style="display:flex;"><span>                path=route.url_path,
</span></span><span style="display:flex;"><span>                methods=route.methods,
</span></span><span style="display:flex;"><span>                endpoint=self._update_resource,
</span></span><span style="display:flex;"><span>                tags=route.tags,
</span></span><span style="display:flex;"><span>                description=route.description,
</span></span><span style="display:flex;"><span>                name=route.name or <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_edit&#39;</span>,
</span></span><span style="display:flex;"><span>                status_code=route.status,
</span></span><span style="display:flex;"><span>                response_model=make_schema(self._resource),
</span></span><span style="display:flex;"><span>                response_description=route.success,
</span></span><span style="display:flex;"><span>                dependencies=[Security(get_user_access, scopes=scopes)],
</span></span><span style="display:flex;"><span>                **kwargs
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># add to router</span>
</span></span><span style="display:flex;"><span>            self._router.routes.append(permission_update_route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> permission_update_route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> StopIteration:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> destroy_route(self, **kwargs):
</span></span><span style="display:flex;"><span>        scopes, search = self._process_route(ResourceFlags.DESTROY)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            route = <span style="color:#fff;font-weight:bold">next</span>(search)
</span></span><span style="display:flex;"><span>            permission_destroy_route = APIRoute(
</span></span><span style="display:flex;"><span>                path=route.url_path,
</span></span><span style="display:flex;"><span>                methods=route.methods,
</span></span><span style="display:flex;"><span>                endpoint=self._create_resource,
</span></span><span style="display:flex;"><span>                tags=route.tags,
</span></span><span style="display:flex;"><span>                description=route.description,
</span></span><span style="display:flex;"><span>                name=route.name or <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_delete&#39;</span>,
</span></span><span style="display:flex;"><span>                status_code=route.status,
</span></span><span style="display:flex;"><span>                response_model=make_schema(self._resource),
</span></span><span style="display:flex;"><span>                response_description=route.success,
</span></span><span style="display:flex;"><span>                dependencies=[Security(get_user_access, scopes=scopes)],
</span></span><span style="display:flex;"><span>                **kwargs
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># add to router</span>
</span></span><span style="display:flex;"><span>            self._router.routes.append(permission_destroy_route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> permission_destroy_route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> StopIteration:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> list_route(self, **kwargs):
</span></span><span style="display:flex;"><span>        scopes, search = self._process_route(ResourceFlags.LIST)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            route = <span style="color:#fff;font-weight:bold">next</span>(search)
</span></span><span style="display:flex;"><span>            permission_list_route = APIRoute(
</span></span><span style="display:flex;"><span>                path=route.url_path,
</span></span><span style="display:flex;"><span>                methods=route.methods,
</span></span><span style="display:flex;"><span>                endpoint=self._create_resource,
</span></span><span style="display:flex;"><span>                tags=route.tags,
</span></span><span style="display:flex;"><span>                description=route.description,
</span></span><span style="display:flex;"><span>                name=route.name or <span style="color:#0ff;font-weight:bold">f</span><span style="color:#0ff;font-weight:bold">&#39;</span><span style="color:#0ff;font-weight:bold">{</span>self._resource.__tablename__<span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">_list&#39;</span>,
</span></span><span style="display:flex;"><span>                status_code=route.status,
</span></span><span style="display:flex;"><span>                response_model=make_schema(self._resource),
</span></span><span style="display:flex;"><span>                response_description=route.success,
</span></span><span style="display:flex;"><span>                dependencies=[Security(get_user_access, scopes=scopes)],
</span></span><span style="display:flex;"><span>                **kwargs
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f"># add to router</span>
</span></span><span style="display:flex;"><span>            self._router.routes.append(permission_list_route)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> permission_list_route
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">except</span> StopIteration:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">class</span> PermissionResource:
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f"># For the various models and their permission, check if the model permission matches the user group</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    __slots__ = <span style="color:#0ff;font-weight:bold">&#39;_router&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;_resource&#39;</span>
</span></span><span style="display:flex;"><span>    app_permissions = Permission()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> __init__(self, resource: ModelT, router: Any):
</span></span><span style="display:flex;"><span>        self._router = router
</span></span><span style="display:flex;"><span>        self._resource = resource
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @classmethod
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">def</span> process_crud(cls, resource, router, flags: <span style="color:#fff;font-weight:bold">int</span> | ResourceFlags | List = <span style="color:#fff;font-weight:bold">None</span>, **kwargs):
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> flags == <span style="color:#ff0;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">raise</span> HTTPException(
</span></span><span style="display:flex;"><span>                status_code=status.HTTP_401_UNAUTHORIZED,
</span></span><span style="display:flex;"><span>                detail=<span style="color:#0ff;font-weight:bold">&#34;Unable to process resource for the selected user&#34;</span>,
</span></span><span style="display:flex;"><span>                headers={<span style="color:#0ff;font-weight:bold">&#34;WWW-Authenticate&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Bearer&#34;</span>},
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        schema = make_schema(resource)
</span></span><span style="display:flex;"><span>        inner = APIRouteResource(resource=resource, router=router, schema=schema, flags=flags)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">match</span> flags:
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.CREATE | <span style="color:#ff0;font-weight:bold">2</span>:
</span></span><span style="display:flex;"><span>                inner.create_route(**kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.UPDATE | <span style="color:#ff0;font-weight:bold">5</span>:
</span></span><span style="display:flex;"><span>                inner.update_route(**kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.DESTROY | <span style="color:#ff0;font-weight:bold">7</span>:
</span></span><span style="display:flex;"><span>                inner.destroy_route(**kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.RETRIEVE | <span style="color:#ff0;font-weight:bold">3</span>:
</span></span><span style="display:flex;"><span>                inner.retrieve_route(**kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> ResourceFlags.LIST | <span style="color:#ff0;font-weight:bold">11</span>:
</span></span><span style="display:flex;"><span>                inner.list_route(**kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> [ResourceFlags.RETRIEVE, ResourceFlags.LIST]:
</span></span><span style="display:flex;"><span>                APIRouteResource.api_readonly(resource, router, schema, **kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> [ResourceFlags.CREATE, ResourceFlags.UPDATE, ResourceFlags.DESTROY]:
</span></span><span style="display:flex;"><span>                APIRouteResource.api_write(resource, router, schema, **kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> [ResourceFlags.CREATE, ResourceFlags.RETRIEVE, ResourceFlags.UPDATE, ResourceFlags.DESTROY,
</span></span><span style="display:flex;"><span>                  ResourceFlags.LIST]:
</span></span><span style="display:flex;"><span>                APIRouteResource.api_read_write(resource, router, schema, **kwargs)
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">case</span> _ <span style="color:#fff;font-weight:bold">as</span> fls:
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> <span style="color:#fff;font-weight:bold">isinstance</span>(fls, (List, Tuple)):
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.CREATE in fls:
</span></span><span style="display:flex;"><span>                        inner.create_route(**kwargs)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.UPDATE in fls:
</span></span><span style="display:flex;"><span>                        inner.update_route(**kwargs)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.LIST in fls:
</span></span><span style="display:flex;"><span>                        inner.list_route(**kwargs)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.DESTROY in fls:
</span></span><span style="display:flex;"><span>                        inner.destroy_route(**kwargs)
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> ResourceFlags.RETRIEVE in fls:
</span></span><span style="display:flex;"><span>                        inner.retrieve_route(**kwargs)
</span></span></code></pre></div>
    </div>
</div>




<p>Let us study the <code>APIRouteResource</code> further. The <code>__init__</code> method of the <code>APIRouteResource</code> calls <code>super().__init__</code> to
set up its attributes as defined in the parent class <code>ManageResource</code>. This call will ensure the <code>_resource</code>, <code>_schema</code>,
and <code>_router</code> attributes are properly setup, and all Config flags are set to <code>False</code>. We can then further customise the
instance of <code>APIRouteResource</code> by using <code>match</code> pattern to check what <code>ResourceFlags</code> value was specified. Depending on
the flag value, the instance of the <code>APIRouteResource</code> can set the corresponding <code>Config</code> flag to <code>True</code>. For example,
if the <code>ResourceFlags.CREATE</code> was provided as flags, then the <code>Config.CREATE_FLAG</code> is set to <code>True</code>. Using this approach
all <code>Config</code> flag attributes can be set following the <code>match</code> and <code>case</code> block. A default <code>case</code> block is set which
evaluates if a sequence (list or tuple) of <code>ResourceFlags</code> is provided as a flag. In this <code>case</code>, any arbitrary set
of <code>Config</code> flag attributes can be set to <code>True</code> depending on values provided in the sequence.</p>
<h4 id="further-read---python-super">Further Read - Python <code>super</code></h4>
<blockquote>
<p>üì¢ &ldquo;Return a proxy object that delegates method calls to a parent or sibling class of type. This is useful for accessing
inherited methods that have been overridden in a class. The object_or_type determines the method resolution order to be
searched. The search starts from the class right after the type&rdquo;. - from the <a href="https://docs.python.org/3/library/functions.html#super">Python official documentation</a>
The <code>super</code> builtin function in Python may seem similar to other OOP language construct (example, super keyword in
Java) for calling a method of a parent class. However, in Python, the <code>super</code> does not simply call a parent class in the
inheritance hierarchy. The super function can be used to specify an actual parent class to call by specifying the name of
the class. The <code>super()</code> could be seen more as a function that generates a linear order of parent classes to select what
parent is next in the execution order of a method. This linear order is technically called Method Resolution Order and
is defined by an object&rsquo;s  <code>__mro__</code> method inherited from type.</p>
<ul>
<li>üìñ <a href="https://docs.python.org/3/library/functions.html#super">Python built-in super</a></li>
<li>üìñ <a href="https://rhettinger.wordpress.com/2011/05/26/super-considered-super/">Python&rsquo;s super() considered super!</a> by Raymond Hattinger</li>
</ul>
</blockquote>
<p>We also defined class methods as utility methods that can initialize an instance of <code>APIRouteResource</code> as read only
instance via <code>api_read_only</code> method; write only instance via <code>api_write</code> method; or read and write instance
via <code>api_read_write</code> method. With these methods we can define routes which can perform CRUD operations on the specified
resource provided as SQLAlchemy models.</p>
<p>To manage access control while using the <code>APIRouteResource</code>, the <code>_process_route</code> is defined to retrieve a list of
scopes assigned to a given resource. Using a <code>Permission</code> object, a set of permission for a given type of resource is
obtained by calling the <code>get_permission</code> method. Also, the allowed CRUD operation as defined in our <code>permission.yml</code>
file for the resource can be obtained by calling the routes property of the <code>app_routes</code> object. This object as shown
earlier holds a register of all API endpoints in the application. We obtain all approved CRUD endpoints for the given
resource and all permissions for the resource as <code>search</code> and <code>scopes</code> variable that is returned by the <code>_process_route</code>
method. The <code>search</code> and <code>scopes</code> variable returned by <code>_process_route</code> can be used to initialize instances
of <code>APIRoute</code> in the overridden methods <code>create_route</code>, <code>retrieve_route</code>, <code>update_route</code>, <code>destroy_route</code>, <code>list_route</code>.
These methods will initialize an <code>APIRoute</code> and add the needed security dependencies to enforce authentication and
authorization for all CRUD operations using the <code>APIRoute.__init__()</code> <code>dependecies</code> keyword parameter.</p>
<p>Now we have the <code>APIRouteResource</code> in place. We need a means by which we can call defined methods of the class to setup
CRUD operations dynamically. We will use the <code>PermissionResource</code> class for this purpose. This class defines
the <code>process_crud</code> method which like the <code>APIRouteResouce</code> uses a pattern matching to select what instance
of <code>APIRouteResource</code> to initialize and then call the needed CRUD
method (<code>create_route</code>, <code>retrieve_route</code>, <code>update_route</code>, <code>destroy_route</code>, or <code>list_route</code>). With this in place, we can
dynamically initialize routes with appropriate permissions and endpoint data which are then added to the FastAPI
application instance. This removes the overhead of defining respective functions for various models in our application
domain. We can simply pass the class or class name as a string to the ManageResource and let it produce the needed
routes for us.</p>






    
    




<div class="position-relative">
    <div class="position-absolute" style="right:0;">
        <button class="btn btn-light" data-clipboard-target="#clipboard_4500ebbb82">
        Copy
        </button>
    </div>
    <div id="clipboard_4500ebbb82">
    <div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py3" data-lang="py3"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> typing <span style="color:#fff;font-weight:bold">import</span> Dict, List, Any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> fastapi <span style="color:#fff;font-weight:bold">import</span> Security, Body, Query
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> schemas
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> authentication.services.jwt_handler <span style="color:#fff;font-weight:bold">import</span> get_user_access
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> catalogue.services <span style="color:#fff;font-weight:bold">import</span> catalogue <span style="color:#fff;font-weight:bold">as</span> catalogue_services
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> models <span style="color:#fff;font-weight:bold">import</span> Catalogue, CatalogueLineItem
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> permissions <span style="color:#fff;font-weight:bold">import</span> Permission
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> routers <span style="color:#fff;font-weight:bold">import</span> app_routes
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">from</span> routers.api <span style="color:#fff;font-weight:bold">import</span> PermissionResource, InferringSchemaRouter, ResourceFlags
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>acl = Permission()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>service = <span style="color:#0ff;font-weight:bold">&#39;Services&#39;</span>
</span></span><span style="display:flex;"><span>prefix = <span style="color:#0ff;font-weight:bold">&#39;catalogue&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>catalogue_router = InferringSchemaRouter()
</span></span><span style="display:flex;"><span>catalogue_item_router = InferringSchemaRouter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r1 = app_routes.find(endpoint=<span style="color:#0ff;font-weight:bold">&#39;basic_search&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">def</span> basic_search(token: <span style="color:#fff;font-weight:bold">str</span> = Security(get_user_access, scopes=acl.get_permission(service, <span style="color:#0ff;font-weight:bold">&#39;basic_search&#39;</span>)),
</span></span><span style="display:flex;"><span>                 data: schemas.CatalogueSearch | Dict = Body(...), skip: <span style="color:#fff;font-weight:bold">int</span> = Query(<span style="color:#fff;font-weight:bold">None</span>),
</span></span><span style="display:flex;"><span>                 limit: <span style="color:#fff;font-weight:bold">int</span> = Query(<span style="color:#fff;font-weight:bold">None</span>)) -&gt; List:
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> token:
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> catalogue_services.basic_search(data=data, skip=skip, limit=limit)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>catalogue_router.add_api_route(r1.url_path, endpoint=basic_search, description=r1.description,
</span></span><span style="display:flex;"><span>                               status_code=r1.status, methods=r1.methods, response_description=r1.success,
</span></span><span style="display:flex;"><span>                               response_model=List[Any])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f"># Set up application CRUD services for Catalogue and CatalogueLineItem</span>
</span></span><span style="display:flex;"><span>catalogue_resource = PermissionResource.process_crud(resource=Catalogue, router=catalogue_router,
</span></span><span style="display:flex;"><span>                                                     flags=[ResourceFlags.LIST, ResourceFlags.RETRIEVE])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>catalogue_item_resource = PermissionResource.process_crud(resource=CatalogueLineItem, router=catalogue_item_router,
</span></span><span style="display:flex;"><span>                                                          flags=[x <span style="color:#fff;font-weight:bold">for</span> x in ResourceFlags])
</span></span></code></pre></div>
    </div>
</div>




<p>We can now add a sample resource to our application. We will be adding the Catalogue resource using
the <code>PermissionResource</code>. In our code sample above, we obtain a <code>Permission</code> object as acl and a registry of API
endpoints using the <code>api_routes</code> object. We also define a <code>catalogue_router</code> and <code>catalogue_item_router</code>. These router
objects will be used to append <code>Catalogue</code> related routes to the application. All the routes for <code>Catalogue</code> can be
retrieved from the <code>api_routes</code>. As an example, we retrieved a route for <code>basic_search</code> as <code>r1</code> using the <code>find()</code>
method of <code>api_routes</code>. To set up our CRUD endpoints, the <code>PermissionResource.process_crud</code> class method is called. This
call will initialize all needed CRUD operations as specified in <code>routers.yml</code> and with matching permissions as specified
in <code>permission.yml</code>.</p>


    


                    
                    <div class="row"><div class="position-relative mx-auto col-lg-9">
                          
<div class="bg-primary overflow-hidden p-3 mt-5 shadow">

    <h4 class="text-white text-center">Read more</h4>

    <div class="d-flex justify-content-center"><a class="p-1 mr-3 d-inline-block text-white" href="/100_pages_fastapi/chapter6/" title="Middleware in FastAPI"><i class="fas fa-chevron-left p-1"></i>Middleware in FastAPI</a>
        <a class="p-1 ml-3 d-inline-block text-white text-right" href="/100_pages_fastapi/chapter8/" title="Testing">Testing<i class="fas fa-chevron-right p-1"></i></a>
    </div>
</div>


                        </div></div> 

                </div>

            </div> 

        </div> 
<script src="https://frier17.github.io/100_pages_fastapi/lib/jquery.min.js"></script> 
<script src="https://frier17.github.io/100_pages_fastapi/lib/popper.min.js"></script> 

<script src="https://frier17.github.io/100_pages_fastapi/js/bootstrap.min.js"></script> 


<script type="text/javascript" src="/100_pages_fastapi/plugins/lunr.min.js"></script>
<script type="text/javascript" src="/100_pages_fastapi/plugins/auto-complete.js"></script>
<link href="/100_pages_fastapi/plugins/auto-complete.css" rel="stylesheet">
<script type="text/javascript">
  
      var baseurl = "https:\/\/frier17.github.io\/100_pages_fastapi\/";
  
</script>
<script type="text/javascript" src="/100_pages_fastapi/plugins/search.js"></script>

<script type="text/javascript" src="/100_pages_fastapi/plugins/favorites.js"></script>


<script type="text/javascript" src="/100_pages_fastapi/plugins/clipboard.js"></script>
<script>
  new ClipboardJS('.btn');
</script>
</body>
</html>
